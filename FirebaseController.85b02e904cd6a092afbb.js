"use strict";(self.webpackChunkcrawlear_com=self.webpackChunkcrawlear_com||[]).push([[4988],{93094:(t,s,e)=>{e.r(s),e.d(s,{default:()=>r}),e(39653);var a=e(788),o=(e(50090),e(62613),e(69141)),i=e(22405),c=e(14959);const r=class{constructor(t){this.app=t.app,this.provider=t.provider,this.auth=t.auth,this.db=t.db,this.rdb=t.rdb,this.fbBase=t}async userSearch(t,s,e){try{const e=(0,i.rJ)(this.db,"users"),a=(0,i.P)(e,(0,i.My)("displayName"),(0,i.EO)(t),(0,i.AB)(10)),o=await(0,i.GG)(a),c=[];o.forEach((t=>{const s=t.data();c.push({uid:t.id,displayName:s.displayName,photoURL:s.photoURL})})),s&&s(c)}catch(t){e&&e(t)}}async getUser(t,s,e){const a=(0,i.H9)(this.db,"users",t),o=await(0,i.x7)(a);if(o.exists()){const t=o.data();t.uid=a.id,s&&s(t)}else e&&e()}transformGamesIntoData(t){return{name:t.name,uids:t.uids,jids:t.jids,date:t.date,location:t.location,gameType:t.gameType,players:t.players,judges:t.judges||[],isPublic:t.isPublic,maxTime:t.maxTime,maxPoints:t.maxPoints,zones:t.zones,gates:t.gates,gameStatus:t.gameStatus,owner:t.owner,courtesyTime:t.courtesyTime}}transformGamesIntoModel(t){let s=[];return t.forEach((t=>{let e;const o=t.data();o.zones||(o.players.forEach((t=>{t.zones=[{fiascoControlTextValues:[],controlTextValues:[],gateProgression:1,gateProgressionData:[],gatesWithBonification:0,gatesWithFail:0,judgedBy:[],points:t.points,totalPoints:t.points,simpathyPoints:0,time:t.time,handicap:0}],t.totalTime=t.time,t.totalPoints=t.points,t.totalGateProgression=1})),o.gates=[1],o.zones=1),e=new a.Game(o.name,o.date,o.location,o.isPublic,o.gameType,o.players,o.judges||[],o.maxTime,o.maxPoints,o.gates,o.zones,o.gameStatus,o.uids,o.jids,o.owner),e.setGameId(t.id),s.push(e)})),s}async getGamesFromUser(t,s,e,a){try{const a=[],o=(0,i.P)((0,i.rJ)(this.db,"games"),(0,i._M)("uids","array-contains",t),(0,i._M)("gameStatus","<",2));(await(0,i.GG)(o)).docs.forEach((e=>{const o=e.data();(!o.jids||o.jids.indexOf(t)<0)&&(s&&o.isPublic||!s)&&a.push(e)})),e&&e(this.transformGamesIntoModel(a))}catch(t){a&&a()}}async getGamesFromJudge(t,s,e,a){try{const a=[],o=(0,i.P)((0,i.rJ)(this.db,"games"),(0,i._M)("jids","array-contains",t),(0,i._M)("gameStatus","<",2));(await(0,i.GG)(o)).docs.forEach((t=>{const e=t.data();(s&&e.isPublic||!s)&&a.push(t)})),e&&e(this.transformGamesIntoModel(a))}catch(t){a&&a()}}async getFinishedGamesFromUid(t,s,e){try{const e=(0,i.P)((0,i.rJ)(this.db,"games"),(0,i.Uo)((0,i._M)("gameStatus","==",2),(0,i.or)((0,i._M)("uids","array-contains",t),(0,i._M)("jids","array-contains",t)))),a=await(0,i.GG)(e);s&&s(this.transformGamesIntoModel(a.docs))}catch(t){e&&e()}}async setGame(t,s,e){try{const e=await(0,i.gS)((0,i.rJ)(this.db,"games"),this.transformGamesIntoData(t));t.gid=e.id,s&&s(t)}catch(t){e&&e()}}updateGame(t){(0,i.mZ)((0,i.H9)(this.db,"games",t.gid),this.transformGamesIntoData(t))}async removeGame(t){await(0,i.kd)((0,i.H9)(this.db,"games",t)),(0,o.TF)((0,o.KR)(this.rdb,"gameProgression/".concat(t,"/"))),(0,o.TF)((0,o.KR)(this.rdb,"presenceRequests/".concat(t,"/")))}async removeIdFromGame(t,s,e){const a=(0,i.H9)(this.db,"games",t.gid),o=await(0,i.x7)(a);if(o.exists()){const a=o.data(),c=a[e].indexOf(s);a.gid=o.id,a[e].splice(c,1);const r=this.transformGamesIntoData(a),n={};return n[e]=r[e],r[e]=n[e],(0,i.mZ)((0,i.H9)(this.db,"games",t.gid),n),a}return t}async setGpx(t,s,e){try{if(t.gid)await(0,i.BN)((0,i.H9)(this.db,"gpx",t.gid),{data:t.data}),s&&s(t);else{const e=await(0,i.gS)((0,i.rJ)(this.db,"gpx"),{data:t.data});t.gid=e.id,s&&s(t)}}catch(t){e&&e()}}async getLovedRoutes(t,s,e){try{const e=(0,i.P)((0,i.rJ)(this.db,"routeLove"),(0,i._M)("uid","==",t));(await(0,i.GG)(e)).docs.forEach((async t=>{const e=t.data();await this.fbBase.getRoute(e.rid,!1,(t=>{t.rid=e.rid,s(t)}),(()=>{}))}))}catch(t){e&&e()}}async getRouteLove(t,s,e,a){try{const a=(0,i.P)((0,i.rJ)(this.db,"routeLove"),(0,i._M)("uid","==",t),(0,i._M)("rid","==",s)),o=await(0,i.GG)(a);e&&e(o.docs.length>0,o.docs[0].id)}catch(t){a&&a()}}async loveRoute(t,s,e,a){try{const a=await(0,i.gS)((0,i.rJ)(this.db,"routeLove"),{uid:t,rid:s});e&&e(a.id)}catch(t){a&&a()}}async unloveRoute(t,s,e){try{await(0,i.kd)((0,i.H9)(this.db,"routeLove",t)),s&&s()}catch(t){e&&e()}}async setRoute(t,s,e){this.setGpx(t.gpx,(async a=>{try{const o=t.transformIntoData(a.gid);if(t.rid&&a.gid)await(0,i.BN)((0,i.H9)(this.db,"routes",t.rid),o);else if(a.gid){t.gpx=a.gid,delete t.rid;const s=await(0,i.gS)((0,i.rJ)(this.db,"routes"),o);t.rid=s.id}else e&&e();t.gpx=a,s&&s(t)}catch(t){e&&e()}}),(()=>{e&&e()}))}async getRoutesFromUser(t,s,e){try{const a=[],o=(0,i.P)((0,i.rJ)(this.db,"routes"),(0,i._M)("uids","array-contains",t));(await(0,i.GG)(o)).docs.forEach((t=>{const o=t.data();o.gpx?this.fbBase.getGpx(o.gpx,(e=>{o.gpx=e,o.gpx.gid=e.gid,a.push({...o,rid:t.id}),s&&s(a)}),e):(a.push({...t.data(),rid:t.id}),s&&s(a))}))}catch(t){e&&e()}}async removeRoute(t,s,e,a){s&&await(0,i.kd)((0,i.H9)(this.db,"gpx",s)),await(0,i.kd)((0,i.H9)(this.db,"routes",t)),e&&e()}setUserInContext(t,s){t.instagram=t.instagram||"",window.crawlear={...window.crawlear,user:t},window.crawlear.user.uid=s}logout(){(0,c.xI)().signOut(),window.crawlear.user={}}getUserGameRequests(t,s,e,a,i){const c=(0,o.KR)(this.rdb,"gameRequests/".concat(t));(0,o._O)(c,(t=>{const s={};s[t.key]=t.val(),a(s)})),(0,o.U0)(c,(t=>{i(t.key)}))}getGameProgressionOnce(t,s,e){(0,o.Jt)((0,o.KR)(this.rdb,"gameProgression/".concat(t))).then((t=>{s&&s(t.key,t.val())}),e)}getGameProgression(t,s,e,a,i){const c=(0,o.KR)(this.rdb,"gameProgression/".concat(t));(0,o._O)(c,(t=>{a(t.key,t.val())})),(0,o.M4)(c,(t=>{i(t.key,t.val())}))}setGameProgression(t,s,e,a,i){(0,o.hZ)((0,o.KR)(this.rdb,"gameProgression/".concat(t,"/").concat(e,"/").concat(s,"/").concat(a)),i)}removeGameProgression(t){(0,o.TF)((0,o.KR)(this.rdb,"gameProgression/".concat(t)))}getGameResult(t,s,e){(0,o.Jt)((0,o.KR)(this.rdb,"gameProgression/".concat(t.gid))).then((e=>{const a=e.val();Object.entries(a).forEach(((s,e)=>{Object.entries(s[1]).forEach(((s,a)=>{s[1].data&&(t.players[e].zones[a]=s[1].data)}))})),s&&s(t)}),e)}createGameProgression(t){for(let s=0;s<t.players.length;s++)for(let e=0;e<t.zones;e++)this.setGameProgression(t.gid,t.players[s].id,t.players[s].group,e,{status:"waiting",data:{}})}acceptGameRequest(t,s){(0,o.hZ)((0,o.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(s,"/status/")),"accepted"),(0,o.TF)((0,o.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(s,"/")))}rejectGameRequest(t,s){(0,o.hZ)((0,o.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(s,"/status/")),"rejected"),(0,o.TF)((0,o.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(s,"/")))}setUserGameRequest(t,s,e,a,i){const c=(0,o.VC)((0,o.KR)(this.rdb,"gameRequests/".concat(e,"/")),{fromUid:t,fromName:s,toUid:e,gameName:a,date:(new Date).toLocaleDateString(),status:"pending"});(0,o.Zy)(c,(t=>{const s=t.val();s&&i(s,s.status)}))}setDirectorPresenceRequest(t,s,e,a,i){const c=(0,o.VC)((0,o.KR)(this.rdb,"presenceRequests/".concat(t,"/")),{zone:s,playerName:e,fromName:a,date:(new Date).toLocaleDateString(),status:"pending"});(0,o.Zy)(c,(t=>{const s=t.val();s&&i(s,t.key)}))}getDirectorPresenceRequest(t,s,e){const a=(0,o.KR)(this.rdb,"presenceRequests/".concat(t));(0,o._O)(a,(t=>{s(t.key,t.val())})),(0,o.M4)(a,(t=>{e(t.key,t.val())}))}acceptDirectorPresenceRequest(t,s){(0,o.hZ)((0,o.KR)(this.rdb,"presenceRequests/".concat(t,"/").concat(s,"/status/")),"accepted")}removeDirectorPresenceRequest(t){(0,o.TF)((0,o.KR)(this.rdb,"presenceRequests/".concat(t)))}async setPost(t,s,e,a,o,c,r){const n={uid:t,gid:o,date:e,url:s,text:a};if(a.length>=0&&s.length>=0)try{const t=await(0,i.gS)((0,i.rJ)(this.db,"socialPosts"),n);n.pid=t.id,c&&c(n)}catch(t){r&&r()}else r&&r()}async setFollow(t,s,e,a){try{const a=await(0,i.gS)((0,i.rJ)(this.db,"follows"),{fromUid:t,toUid:s});e&&e(a.id)}catch(t){a&&a()}}async removeFollow(t,s,e){await(0,i.kd)((0,i.H9)(this.db,"follows",t)),s&&s()}async getPost(t,s,e){const a=(0,i.H9)(this.db,"socialPosts",t),o=await(0,i.x7)(a);if(o.exists()){const t=o.data();t.pid=a.id,s(t)}else e()}async getPosts(t,s,e){try{const e=(0,i.P)((0,i.rJ)(this.db,"socialPosts"),(0,i._M)("uid","==",t),(0,i.My)("date","desc"),(0,i.AB)(10)),a=await(0,i.GG)(e),o=[];a.docs.forEach((t=>{o.push({...t.data(),pid:t.id})})),s&&s(o)}catch(t){e&&e()}}async getPostsFromFollowFeed(t,s,e){try{const e=[],a=(0,i.P)((0,i.rJ)(this.db,"follows"),(0,i._M)("fromUid","==",t)),o=(await(0,i.GG)(a)).docs;for(;o.length>0;){const t=[];o.splice(0,10).forEach((s=>{const e=s.data();t.push(e.toUid)}));const s=(0,i.P)((0,i.rJ)(this.db,"socialPosts"),(0,i._M)("uid","in",t),(0,i.My)("date","desc"),(0,i.AB)(10));(await(0,i.GG)(s)).docs.forEach((t=>{const s=t.data();s.pid=t.id,e.push(s)}))}s&&s(e)}catch(t){e&&e()}}async removePost(t,s,e){await(0,i.kd)((0,i.H9)(this.db,"socialPosts",t)),this.removeLikes(t,10),s&&s()}async getPostLikesCount(t,s,e){try{const e=(0,i.P)((0,i.rJ)(this.db,"likes"),(0,i._M)("pid","==",t),(0,i.AB)(15)),a=(await(0,i.GG)(e)).docs.length;s&&s(a)}catch(t){e&&e()}}async getIfPostIsLiked(t,s,e,a){try{const a=(0,i.P)((0,i.rJ)(this.db,"likes"),(0,i._M)("uid","==",s),(0,i._M)("pid","==",t),(0,i.AB)(1)),o=await(0,i.GG)(a),c=1===o.docs.length;e&&e(c,c?o.docs[0].id:"")}catch(t){a&&a()}}async getFidFromFollow(t,s,e,a){try{const a=(0,i.P)((0,i.rJ)(this.db,"follows"),(0,i._M)("fromUid","==",t),(0,i._M)("toUid","==",s),(0,i.AB)(1)),o=await(0,i.GG)(a),c=1===o.docs.length?o.docs[0].id:-1;e&&e(c)}catch(t){a&&a()}}async setLike(t,s,e,a){const o={pid:t,uid:s};try{const t=await(0,i.gS)((0,i.rJ)(this.db,"likes"),o);e&&e(t.id)}catch(t){a&&a()}}async removeLike(t,s,e){await(0,i.kd)((0,i.H9)(this.db,"likes",t)),s&&s()}async removeLikes(t,s){const e=(0,i.P)((0,i.rJ)(this.db,"likes"),(0,i._M)("pid","==",t),(0,i.My)("__name__"),(0,i.AB)(s));return new Promise(((t,s)=>{this.deleteQueryBatch(e,t).catch(s)}))}async deleteQueryBatch(t,s){const e=await(0,i.GG)(t);0!==e.size?(e.docs.forEach((async t=>{const s=(0,i.wP)(this.db);s.delete(t.ref),s.commit()})),setTimeout((()=>{this.deleteQueryBatch(t,s)}),100)):s()}}}}]);