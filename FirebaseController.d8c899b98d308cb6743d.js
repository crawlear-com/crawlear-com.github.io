"use strict";(self.webpackChunkcrawlear_com=self.webpackChunkcrawlear_com||[]).push([[4988],{93094:(t,e,s)=>{s.r(e),s.d(e,{default:()=>u}),s(39653);var a=s(788),r=(s(50090),s(62613),s(69141)),o=s(22405),i=s(14959);function n(t,e){var s=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),s.push.apply(s,a)}return s}function c(t){for(var e=1;e<arguments.length;e++){var s=null!=arguments[e]?arguments[e]:{};e%2?n(Object(s),!0).forEach((function(e){d(t,e,s[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(s)):n(Object(s)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(s,e))}))}return t}function d(t,e,s){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var s=e.call(t,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:s,enumerable:!0,configurable:!0,writable:!0}):t[e]=s,t}const u=class{constructor(t){this.app=t.app,this.provider=t.provider,this.auth=t.auth,this.db=t.db,this.rdb=t.rdb,this.fbBase=t}async userSearch(t,e,s){try{const s=(0,o.rJ)(this.db,"users"),a=(0,o.P)(s,(0,o.My)("displayName"),(0,o.EO)(t),(0,o.AB)(10)),r=await(0,o.GG)(a),i=[];r.forEach((t=>{const e=t.data();i.push({uid:t.id,displayName:e.displayName,photoURL:e.photoURL})})),e&&e(i)}catch(t){s&&s(t)}}async getUser(t,e,s){const a=(0,o.H9)(this.db,"users",t),r=await(0,o.x7)(a);if(r.exists()){const t=r.data();t.uid=a.id,e&&e(t)}else s&&s()}transformGamesIntoData(t){return{name:t.name,uids:t.uids,jids:t.jids,date:t.date,location:t.location,gameType:t.gameType,players:t.players,judges:t.judges||[],isPublic:t.isPublic,maxTime:t.maxTime,maxPoints:t.maxPoints,zones:t.zones,gates:t.gates,gameStatus:t.gameStatus,owner:t.owner,courtesyTime:t.courtesyTime}}transformGamesIntoModel(t){let e=[];return t.forEach((t=>{let s;const r=t.data();r.zones||(r.players.forEach((t=>{t.zones=[{fiascoControlTextValues:[],controlTextValues:[],gateProgression:1,gateProgressionData:[],gatesWithBonification:0,gatesWithFail:0,judgedBy:[],points:t.points,totalPoints:t.points,simpathyPoints:0,time:t.time,handicap:0}],t.totalTime=t.time,t.totalPoints=t.points,t.totalGateProgression=1})),r.gates=[1],r.zones=1),s=new a.Zt(r.name,r.date,r.location,r.isPublic,r.gameType,r.players,r.judges||[],r.maxTime,r.maxPoints,r.gates,r.zones,r.gameStatus,r.uids,r.jids,r.owner),s.setGameId(t.id),e.push(s)})),e}async getGamesFromUser(t,e,s,a){try{const a=[],r=(0,o.P)((0,o.rJ)(this.db,"games"),(0,o._M)("uids","array-contains",t),(0,o._M)("gameStatus","<",2));(await(0,o.GG)(r)).docs.forEach((s=>{const r=s.data();(!r.jids||r.jids.indexOf(t)<0)&&(e&&r.isPublic||!e)&&a.push(s)})),s&&s(this.transformGamesIntoModel(a))}catch(t){a&&a()}}async getGamesFromJudge(t,e,s,a){try{const a=[],r=(0,o.P)((0,o.rJ)(this.db,"games"),(0,o._M)("jids","array-contains",t),(0,o._M)("gameStatus","<",2));(await(0,o.GG)(r)).docs.forEach((t=>{const s=t.data();(e&&s.isPublic||!e)&&a.push(t)})),s&&s(this.transformGamesIntoModel(a))}catch(t){a&&a()}}async getFinishedGamesFromUid(t,e,s){try{const s=(0,o.P)((0,o.rJ)(this.db,"games"),(0,o.Uo)((0,o._M)("gameStatus","==",2),(0,o.or)((0,o._M)("uids","array-contains",t),(0,o._M)("jids","array-contains",t)))),a=await(0,o.GG)(s);e&&e(this.transformGamesIntoModel(a.docs))}catch(t){s&&s()}}async setGame(t,e,s){try{const s=await(0,o.gS)((0,o.rJ)(this.db,"games"),this.transformGamesIntoData(t));t.gid=s.id,e&&e(t)}catch(t){s&&s()}}updateGame(t){(0,o.mZ)((0,o.H9)(this.db,"games",t.gid),this.transformGamesIntoData(t))}async removeGame(t){await(0,o.kd)((0,o.H9)(this.db,"games",t)),(0,r.TF)((0,r.KR)(this.rdb,"gameProgression/".concat(t,"/"))),(0,r.TF)((0,r.KR)(this.rdb,"presenceRequests/".concat(t,"/")))}async removeIdFromGame(t,e,s){const a=(0,o.H9)(this.db,"games",t.gid),r=await(0,o.x7)(a);if(r.exists()){const a=r.data(),i=a[s].indexOf(e);a.gid=r.id,a[s].splice(i,1);const n=this.transformGamesIntoData(a),c={};return c[s]=n[s],n[s]=c[s],(0,o.mZ)((0,o.H9)(this.db,"games",t.gid),c),a}return t}async setGpx(t,e,s){try{if(t.gid)await(0,o.BN)((0,o.H9)(this.db,"gpx",t.gid),{data:t.data}),e&&e(t);else{const s=await(0,o.gS)((0,o.rJ)(this.db,"gpx"),{data:t.data});t.gid=s.id,e&&e(t)}}catch(t){s&&s()}}async getLovedRoutes(t,e,s){try{const s=(0,o.P)((0,o.rJ)(this.db,"routeLove"),(0,o._M)("uid","==",t));(await(0,o.GG)(s)).docs.forEach((async t=>{const s=t.data();await this.fbBase.getRoute(s.rid,!1,(t=>{t.rid=s.rid,e(t)}),(()=>{}))}))}catch(t){s&&s()}}async getRouteLove(t,e,s,a){try{const a=(0,o.P)((0,o.rJ)(this.db,"routeLove"),(0,o._M)("uid","==",t),(0,o._M)("rid","==",e)),r=await(0,o.GG)(a);s&&s(r.docs.length>0,r.docs[0].id)}catch(t){a&&a()}}async loveRoute(t,e,s,a){try{const a=await(0,o.gS)((0,o.rJ)(this.db,"routeLove"),{uid:t,rid:e});s&&s(a.id)}catch(t){a&&a()}}async unloveRoute(t,e,s){try{await(0,o.kd)((0,o.H9)(this.db,"routeLove",t)),e&&e()}catch(t){s&&s()}}async setRoute(t,e,s){this.setGpx(t.gpx,(async a=>{try{const r=t.transformIntoData(a.gid);if(t.rid&&a.gid)await(0,o.BN)((0,o.H9)(this.db,"routes",t.rid),r);else if(a.gid){t.gpx=a.gid,delete t.rid;const e=await(0,o.gS)((0,o.rJ)(this.db,"routes"),r);t.rid=e.id}else s&&s();t.gpx=a,e&&e(t)}catch(t){s&&s()}}),(()=>{s&&s()}))}async getRoutesFromUser(t,e,s){try{const a=[],r=(0,o.P)((0,o.rJ)(this.db,"routes"),(0,o._M)("uids","array-contains",t));(await(0,o.GG)(r)).docs.forEach((t=>{const r=t.data();r.gpx?this.fbBase.getGpx(r.gpx,(s=>{r.gpx=s,r.gpx.gid=s.gid,a.push(c(c({},r),{},{rid:t.id})),e&&e(a)}),s):(a.push(c(c({},t.data()),{},{rid:t.id})),e&&e(a))}))}catch(t){s&&s()}}async removeRoute(t,e,s,a){e&&await(0,o.kd)((0,o.H9)(this.db,"gpx",e)),await(0,o.kd)((0,o.H9)(this.db,"routes",t)),s&&s()}setUserInContext(t,e){t.instagram=t.instagram||"",window.crawlear=c(c({},window.crawlear),{},{user:t}),window.crawlear.user.uid=e}logout(){(0,i.xI)().signOut(),window.crawlear.user={}}getUserGameRequests(t,e,s){const a=(0,r.KR)(this.rdb,"gameRequests/".concat(t));(0,r._O)(a,(t=>{e(t.key,t.val())})),(0,r.U0)(a,(t=>{s(t.key)}))}getGameProgressionOnce(t,e,s){(0,r.Jt)((0,r.KR)(this.rdb,"gameProgression/".concat(t))).then((t=>{e&&e(t.key,t.val())}),s)}getGameProgression(t,e,s,a,o){const i=(0,r.KR)(this.rdb,"gameProgression/".concat(t));(0,r._O)(i,(t=>{a(t.key,t.val())})),(0,r.M4)(i,(t=>{o(t.key,t.val())}))}setGameProgression(t,e,s,a,o){(0,r.hZ)((0,r.KR)(this.rdb,"gameProgression/".concat(t,"/").concat(s,"/").concat(e,"/").concat(a)),o)}removeGameProgression(t){(0,r.TF)((0,r.KR)(this.rdb,"gameProgression/".concat(t)))}getGameResult(t,e,s){(0,r.Jt)((0,r.KR)(this.rdb,"gameProgression/".concat(t.gid))).then((s=>{const a=s.val();Object.entries(a).forEach(((e,s)=>{Object.entries(e[1]).forEach(((e,a)=>{e[1].data&&(t.players[s].zones[a]=e[1].data)}))})),e&&e(t)}),s)}createGameProgression(t){for(let e=0;e<t.players.length;e++)for(let s=0;s<t.zones;s++)this.setGameProgression(t.gid,t.players[e].id,t.players[e].group,s,{status:"waiting",data:{}})}acceptGameRequest(t,e){(0,r.hZ)((0,r.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(e,"/status/")),"accepted"),(0,r.TF)((0,r.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(e,"/")))}rejectGameRequest(t,e){(0,r.hZ)((0,r.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(e,"/status/")),"rejected"),(0,r.TF)((0,r.KR)(this.rdb,"gameRequests/".concat(t,"/").concat(e,"/")))}setUserGameRequest(t,e,s,a,o){const i=(0,r.VC)((0,r.KR)(this.rdb,"gameRequests/".concat(s,"/")),{fromUid:t,fromName:e,toUid:s,gameName:a,date:(new Date).toLocaleDateString(),status:"pending"});(0,r.Zy)(i,(t=>{const e=t.val();e&&o(e,e.status)}))}setDirectorPresenceRequest(t,e,s,a,o){const i=(0,r.VC)((0,r.KR)(this.rdb,"presenceRequests/".concat(t,"/")),{zone:e,playerName:s,fromName:a,date:(new Date).toLocaleDateString(),status:"pending"});(0,r.Zy)(i,(t=>{const e=t.val();e&&o(e,t.key)}))}getDirectorPresenceRequest(t,e,s){const a=(0,r.KR)(this.rdb,"presenceRequests/".concat(t));(0,r._O)(a,(t=>{e(t.key,t.val())})),(0,r.M4)(a,(t=>{s(t.key,t.val())}))}acceptDirectorPresenceRequest(t,e){(0,r.hZ)((0,r.KR)(this.rdb,"presenceRequests/".concat(t,"/").concat(e,"/status/")),"accepted")}removeDirectorPresenceRequest(t){(0,r.TF)((0,r.KR)(this.rdb,"presenceRequests/".concat(t)))}}}}]);