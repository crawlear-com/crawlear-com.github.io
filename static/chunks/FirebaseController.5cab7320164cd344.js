"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2797],{17518:function(e,t,s){s.r(t),s(5274);var a=s(52759);s(76735),s(67059);var i=s(60516),r=s(69842),o=s(5186);class d{constructor(e){this.app=e.app,this.provider=e.provider,this.auth=e.auth,this.db=e.db,this.rdb=e.rdb,this.fbBase=e}async userSearch(e,t,s){try{let s=(0,r.hJ)(this.db,"users"),a=(0,r.IO)(s,(0,r.Xo)("displayName"),(0,r.e0)(e),(0,r.b9)(10)),i=await (0,r.PL)(a),o=[];i.forEach(e=>{let t=e.data();o.push({uid:e.id,displayName:t.displayName,photoURL:t.photoURL})}),t&&t(o)}catch(e){s&&s(e)}}async getUser(e,t,s){let a=(0,r.JU)(this.db,"users",e),i=await (0,r.QT)(a);if(i.exists()){let e=i.data();e.uid=a.id,t&&t(e)}else s&&s()}transformGamesIntoData(e){return{name:e.name,uids:e.uids,jids:e.jids,date:e.date,location:e.location,gameType:e.gameType,players:e.players,judges:e.judges||[],isPublic:e.isPublic,maxTime:e.maxTime,maxPoints:e.maxPoints,zones:e.zones,gates:e.gates,gameStatus:e.gameStatus,owner:e.owner,courtesyTime:e.courtesyTime}}transformGamesIntoModel(e){let t=[];return e.forEach(e=>{let s;let i=e.data();i.zones||(i.players.forEach(e=>{e.zones=[{fiascoControlTextValues:[],controlTextValues:[],gateProgression:1,gateProgressionData:[],gatesWithBonification:0,gatesWithFail:0,judgedBy:[],points:e.points,totalPoints:e.points,simpathyPoints:0,time:e.time,handicap:0}],e.totalTime=e.time,e.totalPoints=e.points,e.totalGateProgression=1}),i.gates=[1],i.zones=1),(s=new a.lA(i.name,i.date,i.location,i.isPublic,i.gameType,i.players,i.judges||[],i.maxTime,i.maxPoints,i.gates,i.zones,i.gameStatus,i.uids,i.jids,i.owner)).setGameId(e.id),t.push(s)}),t}async getGamesFromUser(e,t,s,a){try{let a=[],i=(0,r.IO)((0,r.hJ)(this.db,"games"),(0,r.ar)("uids","array-contains",e),(0,r.ar)("gameStatus","<",2));(await (0,r.PL)(i)).docs.forEach(s=>{let i=s.data();(!i.jids||0>i.jids.indexOf(e))&&(t&&i.isPublic||!t)&&a.push(s)}),s&&s(this.transformGamesIntoModel(a))}catch(e){a&&a()}}async getGamesFromJudge(e,t,s,a){try{let a=[],i=(0,r.IO)((0,r.hJ)(this.db,"games"),(0,r.ar)("jids","array-contains",e),(0,r.ar)("gameStatus","<",2));(await (0,r.PL)(i)).docs.forEach(e=>{let s=e.data();(t&&s.isPublic||!t)&&a.push(e)}),s&&s(this.transformGamesIntoModel(a))}catch(e){a&&a()}}async getFinishedGamesFromUid(e,t,s){try{let s=(0,r.IO)((0,r.hJ)(this.db,"games"),(0,r.xD)((0,r.ar)("gameStatus","==",2),(0,r.or)((0,r.ar)("uids","array-contains",e),(0,r.ar)("jids","array-contains",e)))),a=await (0,r.PL)(s);t&&t(this.transformGamesIntoModel(a.docs))}catch(e){s&&s()}}async setGame(e,t,s){try{let s=await (0,r.ET)((0,r.hJ)(this.db,"games"),this.transformGamesIntoData(e));e.gid=s.id,t&&t(e)}catch(e){s&&s()}}updateGame(e){(0,r.r7)((0,r.JU)(this.db,"games",e.gid),this.transformGamesIntoData(e))}async removeGame(e){await (0,r.oe)((0,r.JU)(this.db,"games",e)),(0,i.Od)((0,i.iH)(this.rdb,`gameProgression/${e}/`)),(0,i.Od)((0,i.iH)(this.rdb,`presenceRequests/${e}/`))}async removeIdFromGame(e,t,s){let a=(0,r.JU)(this.db,"games",e.gid),i=await (0,r.QT)(a);if(i.exists()){let a=i.data(),o=a[s].indexOf(t);a.gid=i.id,a[s].splice(o,1);let d=this.transformGamesIntoData(a),c={};return c[s]=d[s],d[s]=c[s],(0,r.r7)((0,r.JU)(this.db,"games",e.gid),c),a}return e}async setGpx(e,t,s){try{if(e.gid)await (0,r.pl)((0,r.JU)(this.db,"gpx",e.gid),{data:e.data}),t&&t(e);else{let s=await (0,r.ET)((0,r.hJ)(this.db,"gpx"),{data:e.data});e.gid=s.id,t&&t(e)}}catch(e){s&&s()}}async getLovedRoutes(e,t,s){try{let s=(0,r.IO)((0,r.hJ)(this.db,"routeLove"),(0,r.ar)("uid","==",e));(await (0,r.PL)(s)).docs.forEach(async e=>{let s=e.data();await this.getRoute(s.rid,!1,e=>{e.rid=s.rid,t(e)},()=>{})})}catch(e){s&&s()}}async getRouteLove(e,t,s,a){try{let a=(0,r.IO)((0,r.hJ)(this.db,"routeLove"),(0,r.ar)("uid","==",e),(0,r.ar)("rid","==",t)),i=await (0,r.PL)(a);s&&s(i.docs.length>0,i.docs[0].id)}catch(e){a&&a()}}async loveRoute(e,t,s,a){try{let a=await (0,r.ET)((0,r.hJ)(this.db,"routeLove"),{uid:e,rid:t});s&&s(a.id)}catch(e){a&&a()}}async unloveRoute(e,t,s){try{await (0,r.oe)((0,r.JU)(this.db,"routeLove",e)),t&&t()}catch(e){s&&s()}}async setRoute(e,t,s){this.setGpx(e.gpx,async a=>{try{let i=e.transformIntoData(a.gid);if(e.rid&&a.gid)await (0,r.pl)((0,r.JU)(this.db,"routes",e.rid),i);else if(a.gid){e.gpx=a.gid;let t=await (0,r.ET)((0,r.hJ)(this.db,"routes"),i);e.rid=t.id}else s&&s();e.gpx=a,t&&t(e)}catch(e){s&&s()}},()=>{s&&s()})}async getRoutesFromUser(e,t,s){try{let a=[],i=(0,r.IO)((0,r.hJ)(this.db,"routes"),(0,r.ar)("uids","array-contains",e));(await (0,r.PL)(i)).docs.forEach(e=>{let i=e.data();i.gpx?this.fbBase.getGpx(i.gpx,s=>{i.gpx=s,i.gpx.gid=s.gid,a.push({...i,rid:e.id}),t&&t(a)},s):(a.push({...e.data(),rid:e.id}),t&&t(a))})}catch(e){s&&s()}}async removeRoute(e,t,s,a){t&&await (0,r.oe)((0,r.JU)(this.db,"gpx",t)),await (0,r.oe)((0,r.JU)(this.db,"routes",e)),s&&s()}setUserInContext(e,t){e.instagram=e.instagram||"",window.crawlear={...window.crawlear,user:e},window.crawlear.user.uid=t}logout(){(0,o.v0)().signOut(),window.crawlear.user={}}getUserGameRequests(e,t,s,a,r){let o=(0,i.iH)(this.rdb,`gameRequests/${e}`);(0,i.yv)(o,e=>{let t={};t[e.key]=e.val(),a(t)}),(0,i.MQ)(o,e=>{r(e.key)})}getGameProgressionOnce(e,t,s){(0,i.U2)((0,i.iH)(this.rdb,`gameProgression/${e}`)).then(e=>{t&&t(e.key,e.val())},s)}getGameProgression(e,t,s,a,r){let o=(0,i.iH)(this.rdb,`gameProgression/${e}`);(0,i.yv)(o,e=>{a(e.key,e.val())}),(0,i.Jr)(o,e=>{r(e.key,e.val())})}setGameProgression(e,t,s,a,r){(0,i.t8)((0,i.iH)(this.rdb,`gameProgression/${e}/${s}/${t}/${a}`),r)}removeGameProgression(e){(0,i.Od)((0,i.iH)(this.rdb,`gameProgression/${e}`))}getGameResult(e,t,s){(0,i.U2)((0,i.iH)(this.rdb,`gameProgression/${e.gid}`)).then(s=>{Object.entries(s.val()).forEach((t,s)=>{Object.entries(t[1]).forEach((t,a)=>{t[1].data&&(e.players[s].zones[a]=t[1].data)})}),t&&t(e)},s)}createGameProgression(e){for(let t=0;t<e.players.length;t++)for(let s=0;s<e.zones;s++)this.setGameProgression(e.gid,e.players[t].id,e.players[t].group,s,{status:"waiting",data:{}})}acceptGameRequest(e,t){(0,i.t8)((0,i.iH)(this.rdb,`gameRequests/${e}/${t}/status/`),"accepted"),(0,i.Od)((0,i.iH)(this.rdb,`gameRequests/${e}/${t}/`))}rejectGameRequest(e,t){(0,i.t8)((0,i.iH)(this.rdb,`gameRequests/${e}/${t}/status/`),"rejected"),(0,i.Od)((0,i.iH)(this.rdb,`gameRequests/${e}/${t}/`))}setUserGameRequest(e,t,s,a,r){let o=(0,i.VF)((0,i.iH)(this.rdb,`gameRequests/${s}/`),{fromUid:e,fromName:t,toUid:s,gameName:a,date:new Date().toLocaleDateString(),status:"pending"});(0,i.jM)(o,e=>{let t=e.val();t&&r(t,t.status)})}setDirectorPresenceRequest(e,t,s,a,r){let o=(0,i.VF)((0,i.iH)(this.rdb,`presenceRequests/${e}/`),{zone:t,playerName:s,fromName:a,date:new Date().toLocaleDateString(),status:"pending"});(0,i.jM)(o,e=>{let t=e.val();t&&r(t,e.key)})}getDirectorPresenceRequest(e,t,s){let a=(0,i.iH)(this.rdb,`presenceRequests/${e}`);(0,i.yv)(a,e=>{t(e.key,e.val())}),(0,i.Jr)(a,e=>{s(e.key,e.val())})}acceptDirectorPresenceRequest(e,t){(0,i.t8)((0,i.iH)(this.rdb,`presenceRequests/${e}/${t}/status/`),"accepted")}removeDirectorPresenceRequest(e){(0,i.Od)((0,i.iH)(this.rdb,`presenceRequests/${e}`))}async setPost(e,t,s,a,i,o,d){let c={uid:e,gid:i,date:s,url:t,text:a};if(a.length>=0&&t.length>=0)try{let e=await (0,r.ET)((0,r.hJ)(this.db,"socialPosts"),c);c.pid=e.id,o&&o(c)}catch(e){d&&d()}else d&&d()}async setFollow(e,t,s,a){try{let a=await (0,r.ET)((0,r.hJ)(this.db,"follows"),{fromUid:e,toUid:t});s&&s(a.id)}catch(e){a&&a()}}async removeFollow(e,t,s){await (0,r.oe)((0,r.JU)(this.db,"follows",e)),t&&t()}async getPost(e,t,s){let a=(0,r.JU)(this.db,"socialPosts",e),i=await (0,r.QT)(a);if(i.exists()){let e=i.data();e.pid=a.id,t(e)}else s()}async getPosts(e,t,s){try{let s=(0,r.IO)((0,r.hJ)(this.db,"socialPosts"),(0,r.ar)("uid","==",e),(0,r.Xo)("date","desc"),(0,r.b9)(10)),a=await (0,r.PL)(s),i=[];a.docs.forEach(e=>{i.push({...e.data(),pid:e.id})}),t&&t(i)}catch(e){s&&s()}}async getPostsFromFollowFeed(e,t,s){try{let s=[],a=(0,r.IO)((0,r.hJ)(this.db,"follows"),(0,r.ar)("fromUid","==",e)),i=(await (0,r.PL)(a)).docs;for(;i.length>0;){let e=[];i.splice(0,10).forEach(t=>{let s=t.data();e.push(s.toUid)});let t=(0,r.IO)((0,r.hJ)(this.db,"socialPosts"),(0,r.ar)("uid","in",e),(0,r.Xo)("date","desc"),(0,r.b9)(10));(await (0,r.PL)(t)).docs.forEach(e=>{let t=e.data();t.pid=e.id,s.push(t)})}t&&t(s)}catch(e){s&&s()}}async removePost(e,t,s){await (0,r.oe)((0,r.JU)(this.db,"socialPosts",e)),this.removeLikes(e,10),t&&t()}async getPostLikesCount(e,t,s){try{let s=(0,r.IO)((0,r.hJ)(this.db,"likes"),(0,r.ar)("pid","==",e),(0,r.b9)(15)),a=(await (0,r.PL)(s)).docs.length;t&&t(a)}catch(e){s&&s()}}async getIfPostIsLiked(e,t,s,a){try{let a=(0,r.IO)((0,r.hJ)(this.db,"likes"),(0,r.ar)("uid","==",t),(0,r.ar)("pid","==",e),(0,r.b9)(1)),i=await (0,r.PL)(a),o=1===i.docs.length;s&&s(o,o?i.docs[0].id:"")}catch(e){a&&a()}}async setLike(e,t,s,a){try{let a=await (0,r.ET)((0,r.hJ)(this.db,"likes"),{pid:e,uid:t});s&&s(a.id)}catch(e){a&&a()}}async removeLike(e,t,s){await (0,r.oe)((0,r.JU)(this.db,"likes",e)),t&&t()}async removeLikes(e,t){let s=(0,r.IO)((0,r.hJ)(this.db,"likes"),(0,r.ar)("pid","==",e),(0,r.Xo)("__name__"),(0,r.b9)(t));return new Promise((e,t)=>{this.deleteQueryBatch(s,e).catch(t)})}async deleteQueryBatch(e,t){let s=await (0,r.PL)(e);if(0===s.size){t();return}s.docs.forEach(async e=>{let t=(0,r.qs)(this.db);t.delete(e.ref),t.commit()}),setTimeout(()=>{this.deleteQueryBatch(e,t)},100)}}t.default=d}}]);