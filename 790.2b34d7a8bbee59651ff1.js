/*! For license information please see 790.2b34d7a8bbee59651ff1.js.LICENSE.txt */
"use strict";(self.webpackChunkcrawlear_com=self.webpackChunkcrawlear_com||[]).push([[790],{15790:(e,t,n)=>{n.d(t,{$1:()=>Vl,AB:()=>Fl,B:()=>Tu,BN:()=>uh,C3:()=>xh,CL:()=>Eh,Ci:()=>$u,Cs:()=>Iu,Dc:()=>P,EO:()=>Ll,FA:()=>z,FC:()=>mh,FD:()=>Ul,GA:()=>wh,GG:()=>oh,GV:()=>_h,H6:()=>Du,H9:()=>bu,HM:()=>Ol,He:()=>f,Ix:()=>Gu,K$:()=>K,LA:()=>Pu,My:()=>kl,NJ:()=>Zl,O5:()=>Th,Os:()=>Ou,P:()=>Sl,Q5:()=>Fu,Rr:()=>ch,St:()=>Uu,T1:()=>pu,Uo:()=>Cl,W6:()=>T,Wq:()=>Xl,Ws:()=>Au,YQ:()=>Jl,_M:()=>_l,_e:()=>ih,aQ:()=>fh,aU:()=>Cu,bI:()=>I,c4:()=>bh,c8:()=>au,cm:()=>gt,fS:()=>Ql,gS:()=>dh,hq:()=>Sh,iB:()=>Lu,kU:()=>ah,kd:()=>hh,lN:()=>th,lo:()=>hu,mZ:()=>lh,me:()=>Mu,nY:()=>sh,ol:()=>Ru,or:()=>Nl,po:()=>qu,qG:()=>it,qi:()=>p,rJ:()=>vu,rf:()=>ql,uY:()=>zu,vN:()=>gu,wP:()=>Dh,x7:()=>nh,yx:()=>Eu,z6:()=>gh});var r=n(78461),s=n(5125),i=n(63424),o=n(36743),a=n(6517);const c="@firebase/firestore";class u{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}u.UNAUTHENTICATED=new u(null),u.GOOGLE_CREDENTIALS=new u("google-credentials-uid"),u.FIRST_PARTY=new u("first-party-uid"),u.MOCK_USER=new u("mock-user");let l="9.23.0";const h=new i.Vy("@firebase/firestore");function d(){return h.logLevel}function f(e){h.setLogLevel(e)}function m(e,...t){if(h.logLevel<=i.$b.DEBUG){const n=t.map(y);h.debug(`Firestore (${l}): ${e}`,...n)}}function g(e,...t){if(h.logLevel<=i.$b.ERROR){const n=t.map(y);h.error(`Firestore (${l}): ${e}`,...n)}}function p(e,...t){if(h.logLevel<=i.$b.WARN){const n=t.map(y);h.warn(`Firestore (${l}): ${e}`,...n)}}function y(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function w(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw g(t),new Error(t)}function v(e,t){e||w()}function I(e,t){e||w()}function b(e,t){return e}const E={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class T extends o.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class S{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class x{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(u.UNAUTHENTICATED)))}shutdown(){}}class D{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class N{constructor(e){this.t=e,this.currentUser=u.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new S;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new S,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{m("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(m("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new S)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(m("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(v("string"==typeof t.accessToken),new x(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return v(null===e||"string"==typeof e),new u(e)}}class C{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=u.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class A{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new C(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(u.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class k{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class R{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(e,t){const n=e=>{null!=e.error&&m("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.T;return this.T=e.token,m("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{m("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.I.getImmediate({optional:!0});e?r(e):m("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(v("string"==typeof e.token),this.T=e.token,new k(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function F(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class V{static A(){const e=62*Math.floor(256/62);let t="";for(;t.length<20;){const n=F(40);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function M(e,t){return e<t?-1:e>t?1:0}function L(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function O(e){return e+"\0"}class P{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new T(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new T(E.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new T(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new T(E.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return P.fromMillis(Date.now())}static fromDate(e){return P.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new P(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?M(this.nanoseconds,e.nanoseconds):M(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class q{constructor(e){this.timestamp=e}static fromTimestamp(e){return new q(e)}static min(){return new q(new P(0,0))}static max(){return new q(new P(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class U{constructor(e,t,n){void 0===t?t=0:t>e.length&&w(),void 0===n?n=e.length-t:n>e.length-t&&w(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===U.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof U?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class B extends U{construct(e,t,n){return new B(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new T(E.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new B(t)}static emptyPath(){return new B([])}}const G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class z extends U{construct(e,t,n){return new z(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),z.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new z(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new T(E.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new T(E.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new T(E.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new T(E.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new z(t)}static emptyPath(){return new z([])}}class K{constructor(e){this.path=e}static fromPath(e){return new K(B.fromString(e))}static fromName(e){return new K(B.fromString(e).popFirst(5))}static empty(){return new K(B.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===B.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return B.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new K(new B(e.slice()))}}class ${constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function j(e){return e.fields.find((e=>2===e.kind))}function Q(e){return e.fields.filter((e=>2!==e.kind))}$.UNKNOWN_ID=-1;class W{constructor(e,t){this.fieldPath=e,this.kind=t}}class H{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new H(0,J.min())}}function Y(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=q.fromTimestamp(1e9===r?new P(n+1,0):new P(n,r));return new J(s,K.empty(),t)}function X(e){return new J(e.readTime,e.key,-1)}class J{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new J(q.min(),K.empty(),-1)}static max(){return new J(q.max(),K.empty(),-1)}}function Z(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=K.comparator(e.documentKey,t.documentKey),0!==n?n:M(e.largestBatchId,t.largestBatchId))}const ee="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class te{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function ne(e){if(e.code!==E.FAILED_PRECONDITION||e.message!==ee)throw e;m("LocalStore","Unexpectedly lost primary lease")}class re{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&w(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new re(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof re?t:re.resolve(t)}catch(e){return re.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):re.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):re.reject(t)}static resolve(e){return new re(((t,n)=>{t(e)}))}static reject(e){return new re(((t,n)=>{n(e)}))}static waitFor(e){return new re(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=re.resolve(!1);for(const n of e)t=t.next((e=>e?re.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new re(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;t(e[c]).next((e=>{i[c]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new re(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class se{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.v=new S,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{t.error?this.v.reject(new ae(e,t.error)):this.v.resolve()},this.transaction.onerror=t=>{const n=de(t.target.error);this.v.reject(new ae(e,n))}}static open(e,t,n,r){try{return new se(t,e.transaction(r,n))}catch(e){throw new ae(t,e)}}get R(){return this.v.promise}abort(e){e&&this.v.reject(e),this.aborted||(m("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new ue(t)}}class ie{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===ie.S((0,o.ZQ)())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return m("SimpleDb","Removing database:",e),le(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!(0,o.zW)())return!1;if(ie.C())return!0;const e=(0,o.ZQ)(),t=ie.S(e),n=0<t&&t<10,r=ie.N(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.env)||void 0===e?void 0:e.k)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(e){return this.db||(m("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ae(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new T(E.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new T(E.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ae(e,r))},r.onupgradeneeded=e=>{m("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.V.O(t,r.transaction,e.oldVersion,this.version).next((()=>{m("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(e){this.F=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.$(e);const t=se.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.P(),e))).catch((e=>(t.abort(e),re.reject(e)))).toPromise();return i.catch((()=>{})),await t.R,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(m("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class oe{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return le(this.L.delete())}}class ae extends T{constructor(e,t){super(E.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ce(e){return"IndexedDbTransactionError"===e.name}class ue{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(m("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(m("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),le(n)}add(e){return m("SimpleDb","ADD",this.store.name,e,e),le(this.store.add(e))}get(e){return le(this.store.get(e)).next((t=>(void 0===t&&(t=null),m("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return m("SimpleDb","DELETE",this.store.name,e),le(this.store.delete(e))}count(){return m("SimpleDb","COUNT",this.store.name),le(this.store.count())}j(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new re(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new re(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}J(e,t){m("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;const r=this.cursor(n);return this.W(r,((e,t,n)=>n.delete()))}X(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.W(r,t)}Z(e){const t=this.cursor({});return new re(((n,r)=>{t.onerror=e=>{const t=de(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}W(e,t){const n=[];return new re(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new oe(s),o=t(s.primaryKey,s.value,i);if(o instanceof re){const e=o.catch((e=>(i.done(),re.reject(e))));n.push(e)}i.isDone?r():null===i.K?s.continue():s.continue(i.K)}})).next((()=>re.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function le(e){return new re(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=de(e.target.error);n(t)}}))}let he=!1;function de(e){const t=ie.S((0,o.ZQ)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new T("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return he||(he=!0,setTimeout((()=>{throw e}),0)),e}}return e}class fe{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){m("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{m("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){ce(e)?m("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ne(e)}await this.et(6e4)}))}}class me{constructor(e,t){this.localStore=e,this.persistence=t}async nt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.st(t,e)))}st(e,t){const n=new Set;let r=t,s=!0;return re.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return m("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}it(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.rt(r,n))).next((n=>(m("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}rt(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=X(t);Z(r,n)>0&&(n=r)})),new J(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ge{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ut&&this.ut(e),e}}function pe(e){return null==e}function ye(e){return 0===e&&1/e==-1/0}function we(e){return"number"==typeof e&&Number.isInteger(e)&&!ye(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function ve(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=be(t)),t=Ie(e.get(n),t);return be(t)}function Ie(e,t){let n=t;const r=e.length;for(let t=0;t<r;t++){const r=e.charAt(t);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function be(e){return e+""}function Ee(e){const t=e.length;if(v(t>=2),2===t)return v(""===e.charAt(0)&&""===e.charAt(1)),B.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&w(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:w()}i=t+2}return new B(r)}ge.ct=-1;const Te=["userId","batchId"];function Se(e,t){return[e,ve(t)]}function xe(e,t,n){return[e,ve(t),n]}const _e={},De=["prefixPath","collectionGroup","readTime","documentId"],Ne=["prefixPath","collectionGroup","documentId"],Ce=["collectionGroup","readTime","prefixPath","documentId"],Ae=["canonicalId","targetId"],ke=["targetId","path"],Re=["path","targetId"],Fe=["collectionId","parent"],Ve=["indexId","uid"],Me=["uid","sequenceNumber"],Le=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Oe=["indexId","uid","orderedDocumentKey"],Pe=["userId","collectionPath","documentId"],qe=["userId","collectionPath","largestBatchId"],Ue=["userId","collectionGroup","largestBatchId"],Be=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Ge=[...Be,"documentOverlays"],ze=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ke=ze,$e=[...Ke,"indexConfiguration","indexState","indexEntries"];class je extends te{constructor(e,t){super(),this.ht=e,this.currentSequenceNumber=t}}function Qe(e,t){const n=b(e);return ie.M(n.ht,t)}function We(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function He(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function Ye(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Xe{constructor(e,t){this.comparator=e,this.root=t||Ze.EMPTY}insert(e,t){return new Xe(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Ze.BLACK,null,null))}remove(e){return new Xe(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Ze.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Je(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Je(this.root,e,this.comparator,!1)}getReverseIterator(){return new Je(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Je(this.root,e,this.comparator,!0)}}class Je{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Ze{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Ze.RED,this.left=null!=r?r:Ze.EMPTY,this.right=null!=s?s:Ze.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Ze(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ze.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Ze.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Ze.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Ze.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw w();if(this.right.isRed())throw w();const e=this.left.check();if(e!==this.right.check())throw w();return e+(this.isRed()?0:1)}}Ze.EMPTY=null,Ze.RED=!0,Ze.BLACK=!1,Ze.EMPTY=new class{constructor(){this.size=0}get key(){throw w()}get value(){throw w()}get color(){throw w()}get left(){throw w()}get right(){throw w()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Ze(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class et{constructor(e){this.comparator=e,this.data=new Xe(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tt(this.data.getIterator())}getIteratorFrom(e){return new tt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof et))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new et(this.comparator);return t.data=e,t}}class tt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function nt(e){return e.hasNext()?e.getNext():void 0}class rt{constructor(e){this.fields=e,e.sort(z.comparator)}static empty(){return new rt([])}unionWith(e){let t=new et(z.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new rt(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return L(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class st extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function it(){return"undefined"!=typeof atob}class ot{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new st("Invalid base64 string: "+e):e}}(e);return new ot(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ot(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return M(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ot.EMPTY_BYTE_STRING=new ot("");const at=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ct(e){if(v(!!e),"string"==typeof e){let t=0;const n=at.exec(e);if(v(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ut(e.seconds),nanos:ut(e.nanos)}}function ut(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function lt(e){return"string"==typeof e?ot.fromBase64String(e):ot.fromUint8Array(e)}function ht(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function dt(e){const t=e.mapValue.fields.__previous_value__;return ht(t)?dt(t):t}function ft(e){const t=ct(e.mapValue.fields.__local_write_time__.timestampValue);return new P(t.seconds,t.nanos)}class mt{constructor(e,t,n,r,s,i,o,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class gt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new gt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof gt&&e.projectId===this.projectId&&e.database===this.database}}const pt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},yt={nullValue:"NULL_VALUE"};function wt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?ht(e)?4:Rt(e)?9007199254740991:10:w()}function vt(e,t){if(e===t)return!0;const n=wt(e);if(n!==wt(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return ft(e).isEqual(ft(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=ct(e.timestampValue),r=ct(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return lt(e.bytesValue).isEqual(lt(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ut(e.geoPointValue.latitude)===ut(t.geoPointValue.latitude)&&ut(e.geoPointValue.longitude)===ut(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ut(e.integerValue)===ut(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ut(e.doubleValue),r=ut(t.doubleValue);return n===r?ye(n)===ye(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return L(e.arrayValue.values||[],t.arrayValue.values||[],vt);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(We(n)!==We(r))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!vt(n[e],r[e])))return!1;return!0}(e,t);default:return w()}}function It(e,t){return void 0!==(e.values||[]).find((e=>vt(e,t)))}function bt(e,t){if(e===t)return 0;const n=wt(e),r=wt(t);if(n!==r)return M(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return M(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ut(e.integerValue||e.doubleValue),r=ut(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Et(e.timestampValue,t.timestampValue);case 4:return Et(ft(e),ft(t));case 5:return M(e.stringValue,t.stringValue);case 6:return function(e,t){const n=lt(e),r=lt(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){const t=M(n[e],r[e]);if(0!==t)return t}return M(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=M(ut(e.latitude),ut(t.latitude));return 0!==n?n:M(ut(e.longitude),ut(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){const t=bt(n[e],r[e]);if(t)return t}return M(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===pt.mapValue&&t===pt.mapValue)return 0;if(e===pt.mapValue)return 1;if(t===pt.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let e=0;e<r.length&&e<i.length;++e){const t=M(r[e],i[e]);if(0!==t)return t;const o=bt(n[r[e]],s[i[e]]);if(0!==o)return o}return M(r.length,i.length)}(e.mapValue,t.mapValue);default:throw w()}}function Et(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return M(e,t);const n=ct(e),r=ct(t),s=M(n.seconds,r.seconds);return 0!==s?s:M(n.nanos,r.nanos)}function Tt(e){return St(e)}function St(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ct(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?lt(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,K.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=St(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${St(e.fields[s])}`;return n+"}"}(e.mapValue):w();var t,n}function xt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function _t(e){return!!e&&"integerValue"in e}function Dt(e){return!!e&&"arrayValue"in e}function Nt(e){return!!e&&"nullValue"in e}function Ct(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function At(e){return!!e&&"mapValue"in e}function kt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return He(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=kt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=kt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Rt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ft(e){return"nullValue"in e?yt:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?xt(gt.empty(),K.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:w()}function Vt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?xt(gt.empty(),K.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?pt:w()}function Mt(e,t){const n=bt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Lt(e,t){const n=bt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ot{constructor(e){this.value=e}static empty(){return new Ot({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!At(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=kt(t)}setAll(e){let t=z.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=kt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());At(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return vt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];At(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){He(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Ot(kt(this.value))}}function Pt(e){const t=[];return He(e.fields,((e,n)=>{const r=new z([e]);if(At(n)){const e=Pt(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new rt(t)}class qt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new qt(e,0,q.min(),q.min(),q.min(),Ot.empty(),0)}static newFoundDocument(e,t,n,r){return new qt(e,1,t,q.min(),n,r,0)}static newNoDocument(e,t){return new qt(e,2,t,q.min(),q.min(),Ot.empty(),0)}static newUnknownDocument(e,t){return new qt(e,3,t,q.min(),q.min(),Ot.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(q.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ot.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ot.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=q.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof qt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new qt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ut{constructor(e,t){this.position=e,this.inclusive=t}}function Bt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?K.comparator(K.fromName(o.referenceValue),n.key):bt(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Gt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!vt(e.position[n],t.position[n]))return!1;return!0}class zt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Kt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class $t{}class jt extends $t{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nn(e,t,n):"array-contains"===t?new an(e,n):"in"===t?new cn(e,n):"not-in"===t?new un(e,n):"array-contains-any"===t?new ln(e,n):new jt(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new rn(e,n):new sn(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(bt(t,this.value)):null!==t&&wt(this.value)===wt(t)&&this.matchesComparison(bt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return w()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Qt extends $t{constructor(e,t){super(),this.filters=e,this.op=t,this.lt=null}static create(e,t){return new Qt(e,t)}matches(e){return Wt(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.ft((e=>e.isInequality()));return null!==e?e.field:null}ft(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function Wt(e){return"and"===e.op}function Ht(e){return"or"===e.op}function Yt(e){return Xt(e)&&Wt(e)}function Xt(e){for(const t of e.filters)if(t instanceof Qt)return!1;return!0}function Jt(e){if(e instanceof jt)return e.field.canonicalString()+e.op.toString()+Tt(e.value);if(Yt(e))return e.filters.map((e=>Jt(e))).join(",");{const t=e.filters.map((e=>Jt(e))).join(",");return`${e.op}(${t})`}}function Zt(e,t){return e instanceof jt?function(e,t){return t instanceof jt&&e.op===t.op&&e.field.isEqual(t.field)&&vt(e.value,t.value)}(e,t):e instanceof Qt?function(e,t){return t instanceof Qt&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&Zt(n,t.filters[r])),!0)}(e,t):void w()}function en(e,t){const n=e.filters.concat(t);return Qt.create(n,e.op)}function tn(e){return e instanceof jt?function(e){return`${e.field.canonicalString()} ${e.op} ${Tt(e.value)}`}(e):e instanceof Qt?function(e){return e.op.toString()+" {"+e.getFilters().map(tn).join(" ,")+"}"}(e):"Filter"}class nn extends jt{constructor(e,t,n){super(e,t,n),this.key=K.fromName(n.referenceValue)}matches(e){const t=K.comparator(e.key,this.key);return this.matchesComparison(t)}}class rn extends jt{constructor(e,t){super(e,"in",t),this.keys=on(0,t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class sn extends jt{constructor(e,t){super(e,"not-in",t),this.keys=on(0,t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function on(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>K.fromName(e.referenceValue)))}class an extends jt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Dt(t)&&It(t.arrayValue,this.value)}}class cn extends jt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&It(this.value.arrayValue,t)}}class un extends jt{constructor(e,t){super(e,"not-in",t)}matches(e){if(It(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!It(this.value.arrayValue,t)}}class ln extends jt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Dt(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>It(this.value.arrayValue,e)))}}class hn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.dt=null}}function dn(e,t=null,n=[],r=[],s=null,i=null,o=null){return new hn(e,t,n,r,s,i,o)}function fn(e){const t=b(e);if(null===t.dt){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>Jt(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),pe(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Tt(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Tt(e))).join(",")),t.dt=e}return t.dt}function mn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Kt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!Zt(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Gt(e.startAt,t.startAt)&&Gt(e.endAt,t.endAt)}function gn(e){return K.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pn(e,t){return e.filters.filter((e=>e instanceof jt&&e.field.isEqual(t)))}function yn(e,t,n){let r=yt,s=!0;for(const n of pn(e,t)){let e=yt,t=!0;switch(n.op){case"<":case"<=":e=Ft(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=yt}Mt({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Mt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function wn(e,t,n){let r=pt,s=!0;for(const n of pn(e,t)){let e=pt,t=!0;switch(n.op){case">=":case">":e=Vt(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=pt}Lt({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Lt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class vn{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.wt=null,this._t=null,this.startAt,this.endAt}}function In(e,t,n,r,s,i,o,a){return new vn(e,t,n,r,s,i,o,a)}function bn(e){return new vn(e)}function En(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Tn(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Sn(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function xn(e){return null!==e.collectionGroup}function _n(e){const t=b(e);if(null===t.wt){t.wt=[];const e=Sn(t),n=Tn(t);if(null!==e&&null===n)e.isKeyField()||t.wt.push(new zt(e)),t.wt.push(new zt(z.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.wt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.wt.push(new zt(z.keyField(),e))}}}return t.wt}function Dn(e){const t=b(e);if(!t._t)if("F"===t.limitType)t._t=dn(t.path,t.collectionGroup,_n(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of _n(t)){const t="desc"===n.dir?"asc":"desc";e.push(new zt(n.field,t))}const n=t.endAt?new Ut(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Ut(t.startAt.position,t.startAt.inclusive):null;t._t=dn(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t._t}function Nn(e,t){t.getFirstInequalityField(),Sn(e);const n=e.filters.concat([t]);return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Cn(e,t,n){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function An(e,t){return mn(Dn(e),Dn(t))&&e.limitType===t.limitType}function kn(e){return`${fn(Dn(e))}|lt:${e.limitType}`}function Rn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>tn(e))).join(", ")}]`),pe(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Tt(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Tt(e))).join(",")),`Target(${t})`}(Dn(e))}; limitType=${e.limitType})`}function Fn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):K.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of _n(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Bt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,_n(e),t)||e.endAt&&!function(e,t,n){const r=Bt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,_n(e),t))}(e,t)}function Vn(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Mn(e){return(t,n)=>{let r=!1;for(const s of _n(e)){const e=Ln(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Ln(e,t,n){const r=e.field.isKeyField()?K.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?bt(r,s):w()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return w()}}class On{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){He(this.inner,((t,n)=>{for(const[t,r]of n)e(t,r)}))}isEmpty(){return Ye(this.inner)}size(){return this.innerSize}}const Pn=new Xe(K.comparator);function qn(){return Pn}const Un=new Xe(K.comparator);function Bn(...e){let t=Un;for(const n of e)t=t.insert(n.key,n);return t}function Gn(e){let t=Un;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function zn(){return $n()}function Kn(){return $n()}function $n(){return new On((e=>e.toString()),((e,t)=>e.isEqual(t)))}const jn=new Xe(K.comparator),Qn=new et(K.comparator);function Wn(...e){let t=Qn;for(const n of e)t=t.add(n);return t}const Hn=new et(M);function Yn(){return Hn}function Xn(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ye(t)?"-0":t}}function Jn(e){return{integerValue:""+e}}function Zn(e,t){return we(t)?Jn(t):Xn(e,t)}class er{constructor(){this._=void 0}}function tr(e,t,n){return e instanceof sr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&ht(t)&&(t=dt(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof ir?or(e,t):e instanceof ar?cr(e,t):function(e,t){const n=rr(e,t),r=lr(n)+lr(e.gt);return _t(n)&&_t(e.gt)?Jn(r):Xn(e.serializer,r)}(e,t)}function nr(e,t,n){return e instanceof ir?or(e,t):e instanceof ar?cr(e,t):n}function rr(e,t){return e instanceof ur?_t(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class sr extends er{}class ir extends er{constructor(e){super(),this.elements=e}}function or(e,t){const n=hr(t);for(const t of e.elements)n.some((e=>vt(e,t)))||n.push(t);return{arrayValue:{values:n}}}class ar extends er{constructor(e){super(),this.elements=e}}function cr(e,t){let n=hr(t);for(const t of e.elements)n=n.filter((e=>!vt(e,t)));return{arrayValue:{values:n}}}class ur extends er{constructor(e,t){super(),this.serializer=e,this.gt=t}}function lr(e){return ut(e.integerValue||e.doubleValue)}function hr(e){return Dt(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class dr{constructor(e,t){this.field=e,this.transform=t}}class fr{constructor(e,t){this.version=e,this.transformResults=t}}class mr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new mr}static exists(e){return new mr(void 0,e)}static updateTime(e){return new mr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function gr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class pr{}function yr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Dr(e.key,mr.none()):new Er(e.key,e.data,mr.none());{const n=e.data,r=Ot.empty();let s=new et(z.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new Tr(e.key,r,new rt(s.toArray()),mr.none())}}function wr(e,t,n){e instanceof Er?function(e,t,n){const r=e.value.clone(),s=xr(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof Tr?function(e,t,n){if(!gr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=xr(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Sr(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function vr(e,t,n,r){return e instanceof Er?function(e,t,n,r){if(!gr(e.precondition,t))return n;const s=e.value.clone(),i=_r(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof Tr?function(e,t,n,r){if(!gr(e.precondition,t))return n;const s=_r(e.fieldTransforms,r,t),i=t.data;return i.setAll(Sr(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return gr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Ir(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=rr(r.transform,e||null);null!=s&&(null===n&&(n=Ot.empty()),n.set(r.field,s))}return n||null}function br(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&L(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof ir&&t instanceof ir||e instanceof ar&&t instanceof ar?L(e.elements,t.elements,vt):e instanceof ur&&t instanceof ur?vt(e.gt,t.gt):e instanceof sr&&t instanceof sr}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class Er extends pr{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class Tr extends pr{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Sr(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function xr(e,t,n){const r=new Map;v(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,nr(o,a,n[s]))}return r}function _r(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,tr(e,i,t))}return r}class Dr extends pr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Nr extends pr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Cr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const r=this.mutations[t];r.key.isEqual(e.key)&&wr(r,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=vr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=vr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Kn();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=yr(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(q.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),Wn())}isEqual(e){return this.batchId===e.batchId&&L(this.mutations,e.mutations,((e,t)=>br(e,t)))&&L(this.baseMutations,e.baseMutations,((e,t)=>br(e,t)))}}class Ar{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){v(e.mutations.length===n.length);let r=jn;const s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new Ar(e,t,n,r)}}class kr{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Rr{constructor(e,t){this.count=e,this.unchangedNames=t}}var Fr,Vr;function Mr(e){switch(e){default:return w();case E.CANCELLED:case E.UNKNOWN:case E.DEADLINE_EXCEEDED:case E.RESOURCE_EXHAUSTED:case E.INTERNAL:case E.UNAVAILABLE:case E.UNAUTHENTICATED:return!1;case E.INVALID_ARGUMENT:case E.NOT_FOUND:case E.ALREADY_EXISTS:case E.PERMISSION_DENIED:case E.FAILED_PRECONDITION:case E.ABORTED:case E.OUT_OF_RANGE:case E.UNIMPLEMENTED:case E.DATA_LOSS:return!0}}function Lr(e){if(void 0===e)return g("GRPC error has no .code"),E.UNKNOWN;switch(e){case Fr.OK:return E.OK;case Fr.CANCELLED:return E.CANCELLED;case Fr.UNKNOWN:return E.UNKNOWN;case Fr.DEADLINE_EXCEEDED:return E.DEADLINE_EXCEEDED;case Fr.RESOURCE_EXHAUSTED:return E.RESOURCE_EXHAUSTED;case Fr.INTERNAL:return E.INTERNAL;case Fr.UNAVAILABLE:return E.UNAVAILABLE;case Fr.UNAUTHENTICATED:return E.UNAUTHENTICATED;case Fr.INVALID_ARGUMENT:return E.INVALID_ARGUMENT;case Fr.NOT_FOUND:return E.NOT_FOUND;case Fr.ALREADY_EXISTS:return E.ALREADY_EXISTS;case Fr.PERMISSION_DENIED:return E.PERMISSION_DENIED;case Fr.FAILED_PRECONDITION:return E.FAILED_PRECONDITION;case Fr.ABORTED:return E.ABORTED;case Fr.OUT_OF_RANGE:return E.OUT_OF_RANGE;case Fr.UNIMPLEMENTED:return E.UNIMPLEMENTED;case Fr.DATA_LOSS:return E.DATA_LOSS;default:return w()}}(Vr=Fr||(Fr={}))[Vr.OK=0]="OK",Vr[Vr.CANCELLED=1]="CANCELLED",Vr[Vr.UNKNOWN=2]="UNKNOWN",Vr[Vr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Vr[Vr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Vr[Vr.NOT_FOUND=5]="NOT_FOUND",Vr[Vr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Vr[Vr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Vr[Vr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Vr[Vr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Vr[Vr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Vr[Vr.ABORTED=10]="ABORTED",Vr[Vr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Vr[Vr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Vr[Vr.INTERNAL=13]="INTERNAL",Vr[Vr.UNAVAILABLE=14]="UNAVAILABLE",Vr[Vr.DATA_LOSS=15]="DATA_LOSS";class Or{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Pr}static getOrCreateInstance(){return null===Pr&&(Pr=new Or),Pr}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(e){this.onExistenceFilterMismatchCallbacks.forEach((t=>t(e)))}}let Pr=null;function qr(){return new TextEncoder}const Ur=new a.jz([4294967295,4294967295],0);function Br(e){const t=qr().encode(e),n=new a.VV;return n.update(t),new Uint8Array(n.digest())}function Gr(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.jz([n,r],0),new a.jz([s,i],0)]}class zr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Kr(`Invalid padding: ${t}`);if(n<0)throw new Kr(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Kr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Kr(`Invalid padding when bitmap length is 0: ${t}`);this.It=8*e.length-t,this.Tt=a.jz.fromNumber(this.It)}Et(e,t,n){let r=e.add(t.multiply(a.jz.fromNumber(n)));return 1===r.compare(Ur)&&(r=new a.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Tt).toNumber()}At(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}vt(e){if(0===this.It)return!1;const t=Br(e),[n,r]=Gr(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,r,e);if(!this.At(t))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new zr(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.It)return;const t=Br(e),[n,r]=Gr(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,r,e);this.Rt(t)}}Rt(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Kr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class $r{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,jr.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new $r(q.min(),r,new Xe(M),qn(),Wn())}}class jr{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new jr(n,t,Wn(),Wn(),Wn())}}class Qr{constructor(e,t,n,r){this.Pt=e,this.removedTargetIds=t,this.key=n,this.bt=r}}class Wr{constructor(e,t){this.targetId=e,this.Vt=t}}class Hr{constructor(e,t,n=ot.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Yr{constructor(){this.St=0,this.Dt=Zr(),this.Ct=ot.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(e){e.approximateByteSize()>0&&(this.Nt=!0,this.Ct=e)}Ot(){let e=Wn(),t=Wn(),n=Wn();return this.Dt.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:w()}})),new jr(this.Ct,this.xt,e,t,n)}Ft(){this.Nt=!1,this.Dt=Zr()}Bt(e,t){this.Nt=!0,this.Dt=this.Dt.insert(e,t)}Lt(e){this.Nt=!0,this.Dt=this.Dt.remove(e)}qt(){this.St+=1}Ut(){this.St-=1}Kt(){this.Nt=!0,this.xt=!0}}class Xr{constructor(e){this.Gt=e,this.Qt=new Map,this.jt=qn(),this.zt=Jr(),this.Wt=new Xe(M)}Ht(e){for(const t of e.Pt)e.bt&&e.bt.isFoundDocument()?this.Jt(t,e.bt):this.Yt(t,e.key,e.bt);for(const t of e.removedTargetIds)this.Yt(t,e.key,e.bt)}Xt(e){this.forEachTarget(e,(t=>{const n=this.Zt(t);switch(e.state){case 0:this.te(t)&&n.$t(e.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(e.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(t);break;case 3:this.te(t)&&(n.Kt(),n.$t(e.resumeToken));break;case 4:this.te(t)&&(this.ee(t),n.$t(e.resumeToken));break;default:w()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Qt.forEach(((e,n)=>{this.te(n)&&t(n)}))}ne(e){var t;const n=e.targetId,r=e.Vt.count,s=this.se(n);if(s){const i=s.target;if(gn(i))if(0===r){const e=new K(i.path);this.Yt(n,e,qt.newNoDocument(e,q.min()))}else v(1===r);else{const s=this.ie(n);if(s!==r){const r=this.re(e,s);if(0!==r){this.ee(n);const e=2===r?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(n,e)}null===(t=Or.instance)||void 0===t||t.notifyOnExistenceFilterMismatch(function(e,t,n){var r,s,i,o,a,c;const u={localCacheCount:t,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(u.bloomFilter={applied:0===e,hashCount:null!==(r=null==l?void 0:l.hashCount)&&void 0!==r?r:0,bitmapLength:null!==(o=null===(i=null===(s=null==l?void 0:l.bits)||void 0===s?void 0:s.bitmap)||void 0===i?void 0:i.length)&&void 0!==o?o:0,padding:null!==(c=null===(a=null==l?void 0:l.bits)||void 0===a?void 0:a.padding)&&void 0!==c?c:0}),u}(r,s,e.Vt))}}}}re(e,t){const{unchangedNames:n,count:r}=e.Vt;if(!n||!n.bits)return 1;const{bits:{bitmap:s="",padding:i=0},hashCount:o=0}=n;let a,c;try{a=lt(s).toUint8Array()}catch(e){if(e instanceof st)return p("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{c=new zr(a,i,o)}catch(e){return p(e instanceof Kr?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===c.It?1:r!==t-this.oe(e.targetId,c)?2:0}oe(e,t){const n=this.Gt.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.Gt.ue(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.vt(i)||(this.Yt(e,n,null),r++)})),r}ce(e){const t=new Map;this.Qt.forEach(((n,r)=>{const s=this.se(r);if(s){if(n.current&&gn(s.target)){const t=new K(s.target.path);null!==this.jt.get(t)||this.ae(r,t)||this.Yt(r,t,qt.newNoDocument(t,e))}n.Mt&&(t.set(r,n.Ot()),n.Ft())}}));let n=Wn();this.zt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.se(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.jt.forEach(((t,n)=>n.setReadTime(e)));const r=new $r(e,t,this.Wt,this.jt,n);return this.jt=qn(),this.zt=Jr(),this.Wt=new Xe(M),r}Jt(e,t){if(!this.te(e))return;const n=this.ae(e,t.key)?2:0;this.Zt(e).Bt(t.key,n),this.jt=this.jt.insert(t.key,t),this.zt=this.zt.insert(t.key,this.he(t.key).add(e))}Yt(e,t,n){if(!this.te(e))return;const r=this.Zt(e);this.ae(e,t)?r.Bt(t,1):r.Lt(t),this.zt=this.zt.insert(t,this.he(t).delete(e)),n&&(this.jt=this.jt.insert(t,n))}removeTarget(e){this.Qt.delete(e)}ie(e){const t=this.Zt(e).Ot();return this.Gt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}qt(e){this.Zt(e).qt()}Zt(e){let t=this.Qt.get(e);return t||(t=new Yr,this.Qt.set(e,t)),t}he(e){let t=this.zt.get(e);return t||(t=new et(M),this.zt=this.zt.insert(e,t)),t}te(e){const t=null!==this.se(e);return t||m("WatchChangeAggregator","Detected inactive target",e),t}se(e){const t=this.Qt.get(e);return t&&t.kt?null:this.Gt.le(e)}ee(e){this.Qt.set(e,new Yr),this.Gt.getRemoteKeysForTarget(e).forEach((t=>{this.Yt(e,t,null)}))}ae(e,t){return this.Gt.getRemoteKeysForTarget(e).has(t)}}function Jr(){return new Xe(K.comparator)}function Zr(){return new Xe(K.comparator)}const es={asc:"ASCENDING",desc:"DESCENDING"},ts={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ns={and:"AND",or:"OR"};class rs{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ss(e,t){return e.useProto3Json||pe(t)?t:{value:t}}function is(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function os(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function as(e,t){return is(e,t.toTimestamp())}function cs(e){return v(!!e),q.fromTimestamp(function(e){const t=ct(e);return new P(t.seconds,t.nanos)}(e))}function us(e,t){return function(e){return new B(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function ls(e){const t=B.fromString(e);return v(Rs(t)),t}function hs(e,t){return us(e.databaseId,t.path)}function ds(e,t){const n=ls(t);if(n.get(1)!==e.databaseId.projectId)throw new T(E.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new T(E.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new K(ps(n))}function fs(e,t){return us(e.databaseId,t)}function ms(e){const t=ls(e);return 4===t.length?B.emptyPath():ps(t)}function gs(e){return new B(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ps(e){return v(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function ys(e,t,n){return{name:hs(e,t),fields:n.value.mapValue.fields}}function ws(e,t,n){const r=ds(e,t.name),s=cs(t.updateTime),i=t.createTime?cs(t.createTime):q.min(),o=new Ot({mapValue:{fields:t.fields}}),a=qt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function vs(e,t){let n;if(t instanceof Er)n={update:ys(e,t.key,t.value)};else if(t instanceof Dr)n={delete:hs(e,t.key)};else if(t instanceof Tr)n={update:ys(e,t.key,t.data),updateMask:ks(t.fieldMask)};else{if(!(t instanceof Nr))return w();n={verify:hs(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof sr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof ir)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof ar)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof ur)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw w()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:as(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:w()}(e,t.precondition)),n}function Is(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?mr.updateTime(cs(e.updateTime)):void 0!==e.exists?mr.exists(e.exists):mr.none()}(t.currentDocument):mr.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)v("REQUEST_TIME"===t.setToServerValue),n=new sr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new ir(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new ar(e)}else"increment"in t?n=new ur(e,t.increment):w();const r=z.fromServerFormat(t.fieldPath);return new dr(r,n)}(e,t))):[];if(t.update){t.update.name;const s=ds(e,t.update.name),i=new Ot({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new rt(t.map((e=>z.fromServerFormat(e))))}(t.updateMask);return new Tr(s,i,e,n,r)}return new Er(s,i,n,r)}if(t.delete){const r=ds(e,t.delete);return new Dr(r,n)}if(t.verify){const r=ds(e,t.verify);return new Nr(r,n)}return w()}function bs(e,t){return{documents:[fs(e,t.path)]}}function Es(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=fs(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=fs(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0!==e.length)return As(Qt.create(e,"and"))}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Ns(e.field),direction:xs(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=ss(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Ts(e){let t=ms(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){v(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Ss(e);return t instanceof Qt&&Yt(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new zt(Cs(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,pe(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Ut(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Ut(n,t)}(n.endAt)),In(t,s,o,i,a,"F",c,u)}function Ss(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Cs(e.unaryFilter.field);return jt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Cs(e.unaryFilter.field);return jt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Cs(e.unaryFilter.field);return jt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Cs(e.unaryFilter.field);return jt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return w()}}(e):void 0!==e.fieldFilter?function(e){return jt.create(Cs(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return w()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Qt.create(e.compositeFilter.filters.map((e=>Ss(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return w()}}(e.compositeFilter.op))}(e):w()}function xs(e){return es[e]}function _s(e){return ts[e]}function Ds(e){return ns[e]}function Ns(e){return{fieldPath:e.canonicalString()}}function Cs(e){return z.fromServerFormat(e.fieldPath)}function As(e){return e instanceof jt?function(e){if("=="===e.op){if(Ct(e.value))return{unaryFilter:{field:Ns(e.field),op:"IS_NAN"}};if(Nt(e.value))return{unaryFilter:{field:Ns(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ct(e.value))return{unaryFilter:{field:Ns(e.field),op:"IS_NOT_NAN"}};if(Nt(e.value))return{unaryFilter:{field:Ns(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ns(e.field),op:_s(e.op),value:e.value}}}(e):e instanceof Qt?function(e){const t=e.getFilters().map((e=>As(e)));return 1===t.length?t[0]:{compositeFilter:{op:Ds(e.op),filters:t}}}(e):w()}function ks(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Rs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Fs{constructor(e,t,n,r,s=q.min(),i=q.min(),o=ot.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Fs(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Fs(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Fs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Fs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Vs{constructor(e){this.fe=e}}function Ms(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Ls(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:hs(e,t.key),fields:t.data.value.mapValue.fields,updateTime:is(e,t.version.toTimestamp()),createTime:is(e,t.createTime.toTimestamp())}}(e.fe,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Os(t.version)};else{if(!t.isUnknownDocument())return w();r.unknownDocument={path:n.path.toArray(),version:Os(t.version)}}return r}function Ls(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Os(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Ps(e){const t=new P(e.seconds,e.nanoseconds);return q.fromTimestamp(t)}function qs(e,t){const n=(t.baseMutations||[]).map((t=>Is(e.fe,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const r=t.mutations.map((t=>Is(e.fe,t))),s=P.fromMillis(t.localWriteTimeMs);return new Cr(t.batchId,s,n,r)}function Us(e){const t=Ps(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Ps(e.lastLimboFreeSnapshotVersion):q.min();let r;var s;return void 0!==e.query.documents?(v(1===(s=e.query).documents.length),r=Dn(bn(ms(s.documents[0])))):r=function(e){return Dn(Ts(e))}(e.query),new Fs(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,ot.fromBase64String(e.resumeToken))}function Bs(e,t){const n=Os(t.snapshotVersion),r=Os(t.lastLimboFreeSnapshotVersion);let s;s=gn(t.target)?bs(e.fe,t.target):Es(e.fe,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:fn(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Gs(e){const t=Ts({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Cn(t,t.limit,"L"):t}function zs(e,t){return new kr(t.largestBatchId,Is(e.fe,t.overlayMutation))}function Ks(e,t){const n=t.path.lastSegment();return[e,ve(t.path.popLast()),n]}function $s(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Os(r.readTime),documentKey:ve(r.documentKey.path),largestBatchId:r.largestBatchId}}class js{getBundleMetadata(e,t){return Qs(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:Ps(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return Qs(e).put({bundleId:(n=t).id,createTime:Os(cs(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Ws(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Gs(t.bundledQuery),readTime:Ps(t.readTime)};var t}))}saveNamedQuery(e,t){return Ws(e).put(function(e){return{name:e.name,readTime:Os(cs(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function Qs(e){return Qe(e,"bundles")}function Ws(e){return Qe(e,"namedQueries")}class Hs{constructor(e,t){this.serializer=e,this.userId=t}static de(e,t){const n=t.uid||"";return new Hs(e,n)}getOverlay(e,t){return Ys(e).get(Ks(this.userId,t)).next((e=>e?zs(this.serializer,e):null))}getOverlays(e,t){const n=zn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new kr(t,s);r.push(this.we(e,i))})),re.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(ve(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Ys(e).J("collectionPathOverlayIndex",r))})),re.waitFor(s)}getOverlaysForCollection(e,t,n){const r=zn(),s=ve(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Ys(e).j("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=zs(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=zn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Ys(e).X({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=zs(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}we(e,t){return Ys(e).put(function(e,t,n){const[r,s,i]=Ks(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:vs(e.fe,n.mutation)}}(this.serializer,this.userId,t))}}function Ys(e){return Qe(e,"documentOverlays")}class Xs{constructor(){}_e(e,t){this.me(e,t),t.ge()}me(e,t){if("nullValue"in e)this.ye(t,5);else if("booleanValue"in e)this.ye(t,10),t.pe(e.booleanValue?1:0);else if("integerValue"in e)this.ye(t,15),t.pe(ut(e.integerValue));else if("doubleValue"in e){const n=ut(e.doubleValue);isNaN(n)?this.ye(t,13):(this.ye(t,15),ye(n)?t.pe(0):t.pe(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ye(t,20),"string"==typeof n?t.Ie(n):(t.Ie(`${n.seconds||""}`),t.pe(n.nanos||0))}else if("stringValue"in e)this.Te(e.stringValue,t),this.Ee(t);else if("bytesValue"in e)this.ye(t,30),t.Ae(lt(e.bytesValue)),this.Ee(t);else if("referenceValue"in e)this.ve(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ye(t,45),t.pe(n.latitude||0),t.pe(n.longitude||0)}else"mapValue"in e?Rt(e)?this.ye(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Ee(t)):"arrayValue"in e?(this.Pe(e.arrayValue,t),this.Ee(t)):w()}Te(e,t){this.ye(t,25),this.be(e,t)}be(e,t){t.Ie(e)}Re(e,t){const n=e.fields||{};this.ye(t,55);for(const e of Object.keys(n))this.Te(e,t),this.me(n[e],t)}Pe(e,t){const n=e.values||[];this.ye(t,50);for(const e of n)this.me(e,t)}ve(e,t){this.ye(t,37),K.fromName(e).path.forEach((e=>{this.ye(t,60),this.be(e,t)}))}ye(e,t){e.pe(t)}Ee(e){e.pe(2)}}function Js(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}function Zs(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=Js(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Xs.Ve=new Xs;class ei{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.De(n.value),n=t.next();this.Ce()}xe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ne(n.value),n=t.next();this.ke()}Me(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.De(e);else if(e<2048)this.De(960|e>>>6),this.De(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.De(480|e>>>12),this.De(128|63&e>>>6),this.De(128|63&e);else{const e=t.codePointAt(0);this.De(240|e>>>18),this.De(128|63&e>>>12),this.De(128|63&e>>>6),this.De(128|63&e)}}this.Ce()}$e(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ne(e);else if(e<2048)this.Ne(960|e>>>6),this.Ne(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ne(480|e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e);else{const e=t.codePointAt(0);this.Ne(240|e>>>18),this.Ne(128|63&e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e)}}this.ke()}Oe(e){const t=this.Fe(e),n=Zs(t);this.Be(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Le(e){const t=this.Fe(e),n=Zs(t);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(e){this.Be(e.length),this.buffer.set(e,this.position),this.position+=e.length}Qe(){return this.buffer.slice(0,this.position)}Fe(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}De(e){const t=255&e;0===t?(this.Ue(0),this.Ue(255)):255===t?(this.Ue(255),this.Ue(0)):this.Ue(t)}Ne(e){const t=255&e;0===t?(this.Ge(0),this.Ge(255)):255===t?(this.Ge(255),this.Ge(0)):this.Ge(e)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(e){this.Be(1),this.buffer[this.position++]=e}Ge(e){this.Be(1),this.buffer[this.position++]=~e}Be(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class ti{constructor(e){this.je=e}Ae(e){this.je.Se(e)}Ie(e){this.je.Me(e)}pe(e){this.je.Oe(e)}ge(){this.je.qe()}}class ni{constructor(e){this.je=e}Ae(e){this.je.xe(e)}Ie(e){this.je.$e(e)}pe(e){this.je.Le(e)}ge(){this.je.Ke()}}class ri{constructor(){this.je=new ei,this.ze=new ti(this.je),this.We=new ni(this.je)}seed(e){this.je.seed(e)}He(e){return 0===e?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class si{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Je(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new si(this.indexId,this.documentKey,this.arrayValue,n)}}function ii(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=oi(e.arrayValue,t.arrayValue),0!==n?n:(n=oi(e.directionalValue,t.directionalValue),0!==n?n:K.comparator(e.documentKey,t.documentKey)))}function oi(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class ai{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ye=e.orderBy,this.Xe=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ze=e:this.Xe.push(e)}}tn(e){v(e.collectionGroup===this.collectionId);const t=j(e);if(void 0!==t&&!this.en(t))return!1;const n=Q(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.en(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(void 0!==this.Ze){if(!r.has(this.Ze.field.canonicalString())){const e=n[s];if(!this.nn(this.Ze,e)||!this.sn(this.Ye[i++],e))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Ye.length||!this.sn(this.Ye[i++],e))return!1}return!0}en(e){for(const t of this.Xe)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function ci(e){var t,n;if(v(e instanceof jt||e instanceof Qt),e instanceof jt){if(e instanceof cn){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>jt.create(e.field,"==",t))))||[];return Qt.create(r,"or")}return e}const r=e.filters.map((e=>ci(e)));return Qt.create(r,e.op)}function ui(e){if(0===e.getFilters().length)return[];const t=fi(ci(e));return v(di(t)),li(t)||hi(t)?[t]:t.getFilters()}function li(e){return e instanceof jt}function hi(e){return e instanceof Qt&&Yt(e)}function di(e){return li(e)||hi(e)||function(e){if(e instanceof Qt&&Ht(e)){for(const t of e.getFilters())if(!li(t)&&!hi(t))return!1;return!0}return!1}(e)}function fi(e){if(v(e instanceof jt||e instanceof Qt),e instanceof jt)return e;if(1===e.filters.length)return fi(e.filters[0]);const t=e.filters.map((e=>fi(e)));let n=Qt.create(t,e.op);return n=pi(n),di(n)?n:(v(n instanceof Qt),v(Wt(n)),v(n.filters.length>1),n.filters.reduce(((e,t)=>mi(e,t))))}function mi(e,t){let n;return v(e instanceof jt||e instanceof Qt),v(t instanceof jt||t instanceof Qt),n=e instanceof jt?t instanceof jt?function(e,t){return Qt.create([e,t],"and")}(e,t):gi(e,t):t instanceof jt?gi(t,e):function(e,t){if(v(e.filters.length>0&&t.filters.length>0),Wt(e)&&Wt(t))return en(e,t.getFilters());const n=Ht(e)?e:t,r=Ht(e)?t:e,s=n.filters.map((e=>mi(e,r)));return Qt.create(s,"or")}(e,t),pi(n)}function gi(e,t){if(Wt(t))return en(t,e.getFilters());{const n=t.filters.map((t=>mi(e,t)));return Qt.create(n,"or")}}function pi(e){if(v(e instanceof jt||e instanceof Qt),e instanceof jt)return e;const t=e.getFilters();if(1===t.length)return pi(t[0]);if(Xt(e))return e;const n=t.map((e=>pi(e))),r=[];return n.forEach((t=>{t instanceof jt?r.push(t):t instanceof Qt&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:Qt.create(r,e.op)}class yi{constructor(){this.rn=new wi}addToCollectionParentIndex(e,t){return this.rn.add(t),re.resolve()}getCollectionParents(e,t){return re.resolve(this.rn.getEntries(t))}addFieldIndex(e,t){return re.resolve()}deleteFieldIndex(e,t){return re.resolve()}getDocumentsMatchingTarget(e,t){return re.resolve(null)}getIndexType(e,t){return re.resolve(0)}getFieldIndexes(e,t){return re.resolve([])}getNextCollectionGroupToUpdate(e){return re.resolve(null)}getMinOffset(e,t){return re.resolve(J.min())}getMinOffsetFromCollectionGroup(e,t){return re.resolve(J.min())}updateCollectionGroup(e,t,n){return re.resolve()}updateIndexEntries(e,t){return re.resolve()}}class wi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new et(B.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new et(B.comparator)).toArray()}}const vi=new Uint8Array(0);class Ii{constructor(e,t){this.user=e,this.databaseId=t,this.on=new wi,this.un=new On((e=>fn(e)),((e,t)=>mn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.on.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.on.add(t)}));const s={collectionId:n,parent:ve(r)};return bi(e).put(s)}return re.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[O(t),""],!1,!0);return bi(e).j(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Ee(r.parent))}return n}))}addFieldIndex(e,t){const n=Ti(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Si(e);return s.next((e=>{n.put($s(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Ti(e),r=Si(e),s=Ei(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=Ei(e);let r=!0;const s=new Map;return re.forEach(this.cn(t),(t=>this.an(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=Wn();const r=[];return re.forEach(s,((s,i)=>{var o;m("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${fn(t)}`);const a=function(e,t){const n=j(t);if(void 0===n)return null;for(const t of pn(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(i,s),c=function(e,t){const n=new Map;for(const r of Q(t))for(const t of pn(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?yn(e,s.fieldPath,e.startAt):wn(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Ut(n,r)}(i,s),l=function(e,t){const n=[];let r=!0;for(const s of Q(t)){const t=0===s.kind?wn(e,s.fieldPath,e.endAt):yn(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Ut(n,r)}(i,s),h=this.hn(s,i,u),d=this.hn(s,i,l),f=this.ln(s,i,c),g=this.fn(s.indexId,a,h,u.inclusive,d,l.inclusive,f);return re.forEach(g,(s=>n.H(s,t.limit).next((t=>{t.forEach((t=>{const n=K.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return re.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:ui(Qt.create(e.filters,"and")).map((t=>dn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}fn(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.dn(t[l/c]):vi,h=this.wn(e,a,n[l%c],r),d=this._n(e,a,s[l%c],i),f=o.map((t=>this.wn(e,a,t,!0)));u.push(...this.createRange(h,d,f))}return u}wn(e,t,n,r){const s=new si(e,K.empty(),t,n);return r?s:s.Je()}_n(e,t,n,r){const s=new si(e,K.empty(),t,n);return r?s.Je():s}an(e,t){const n=new ai(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.cn(t);return re.forEach(r,(t=>this.an(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new et(z.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}mn(e,t){const n=new ri;for(const r of Q(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.He(r.kind);Xs.Ve._e(e,s)}return n.Qe()}dn(e){const t=new ri;return Xs.Ve._e(e,t.He(0)),t.Qe()}gn(e,t){const n=new ri;return Xs.Ve._e(xt(this.databaseId,t),n.He(function(e){const t=Q(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Qe()}ln(e,t,n){if(null===n)return[];let r=[];r.push(new ri);let s=0;for(const i of Q(e)){const e=n[s++];for(const n of r)if(this.yn(t,i.fieldPath)&&Dt(e))r=this.pn(r,i,e);else{const t=n.He(i.kind);Xs.Ve._e(e,t)}}return this.In(r)}hn(e,t,n){return this.ln(e,t,n.position)}In(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Qe();return t}pn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new ri;r.seed(n.Qe()),Xs.Ve._e(e,r.He(t.kind)),s.push(r)}return s}yn(e,t){return!!e.filters.find((e=>e instanceof jt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Ti(e),r=Si(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next((e=>{const t=[];return re.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new H(t.sequenceNumber,new J(Ps(t.readTime),new K(Ee(t.documentKey)),t.largestBatchId)):H.empty(),r=e.fields.map((([e,t])=>new W(z.fromServerFormat(e),t)));return new $(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:M(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Ti(e),s=Si(e);return this.Tn(e).next((e=>r.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>re.forEach(t,(t=>s.put($s(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return re.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?re.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),re.forEach(s,(n=>this.En(e,t,n).next((t=>{const s=this.An(r,n);return t.isEqual(s)?re.resolve():this.vn(e,r,n,t,s)})))))))}))}Rn(e,t,n,r){return Ei(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.gn(n,t.key),documentKey:t.key.path.toArray()})}Pn(e,t,n,r){return Ei(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.gn(n,t.key),t.key.path.toArray()])}En(e,t,n){const r=Ei(e);let s=new et(ii);return r.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,t)])},((e,r)=>{s=s.add(new si(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}An(e,t){let n=new et(ii);const r=this.mn(t,e);if(null==r)return n;const s=j(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Dt(i))for(const s of i.arrayValue.values||[])n=n.add(new si(t.indexId,e.key,this.dn(s),r))}else n=n.add(new si(t.indexId,e.key,vi,r));return n}vn(e,t,n,r,s){m("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=nt(i),c=nt(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const r=n(a,c);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(c),c=nt(o)):t?(s(a),a=nt(i)):(a=nt(i),c=nt(o))}}(r,s,ii,(r=>{i.push(this.Rn(e,t,n,r))}),(r=>{i.push(this.Pn(e,t,n,r))})),re.waitFor(i)}Tn(e){let t=1;return Si(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>ii(e,t))).filter(((e,t,n)=>!t||0!==ii(e,n[t-1])));const r=[];r.push(e);for(const s of n){const n=ii(s,e),i=ii(s,t);if(0===n)r[0]=e.Je();else if(n>0&&i<0)r.push(s),r.push(s.Je());else if(i>0)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2){if(this.bn(r[e],r[e+1]))return[];const t=[r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,vi,[]],n=[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,vi,[]];s.push(IDBKeyRange.bound(t,n))}return s}bn(e,t){return ii(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(xi)}getMinOffset(e,t){return re.mapArray(this.cn(t),(t=>this.an(e,t).next((e=>e||w())))).next(xi)}}function bi(e){return Qe(e,"collectionParents")}function Ei(e){return Qe(e,"indexEntries")}function Ti(e){return Qe(e,"indexConfiguration")}function Si(e){return Qe(e,"indexState")}function xi(e){v(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;Z(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new J(t.readTime,t.documentKey,n)}const _i={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Di{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Di(e,Di.DEFAULT_COLLECTION_PERCENTILE,Di.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ni(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.X({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{v(1===a)})));const u=[];for(const e of n.mutations){const r=xe(t,e.key.path,n.batchId);i.push(s.delete(r)),u.push(e.key)}return re.waitFor(i).next((()=>u))}function Ci(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw w();t=e.noDocument}return JSON.stringify(t).length}Di.DEFAULT_COLLECTION_PERCENTILE=10,Di.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Di.DEFAULT=new Di(41943040,Di.DEFAULT_COLLECTION_PERCENTILE,Di.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Di.DISABLED=new Di(-1,0,0);class Ai{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Vn={}}static de(e,t,n,r){v(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Ai(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Ri(e).X({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Fi(e),i=Ri(e);return i.add({}).next((o=>{v("number"==typeof o);const a=new Cr(o,t,n,r),c=function(e,t,n){const r=n.baseMutations.map((t=>vs(e.fe,t))),s=n.mutations.map((t=>vs(e.fe,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new et(((e,t)=>M(e.canonicalString(),t.canonicalString())));for(const e of r){const t=xe(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,_e))}return l.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Vn[o]=a.keys()})),re.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return Ri(e).get(t).next((e=>e?(v(e.userId===this.userId),qs(this.serializer,e)):null))}Sn(e,t){return this.Vn[t]?re.resolve(this.Vn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Vn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Ri(e).X({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(v(t.batchId>=n),s=qs(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Ri(e).X({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Ri(e).j("userMutationsIndex",t).next((e=>e.map((e=>qs(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Se(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Fi(e).X({range:r},((n,r,i)=>{const[o,a,c]=n,u=Ee(a);if(o===this.userId&&t.path.isEqual(u))return Ri(e).get(c).next((e=>{if(!e)throw w();v(e.userId===this.userId),s.push(qs(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new et(M);const r=[];return t.forEach((t=>{const s=Se(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Fi(e).X({range:i},((e,r,s)=>{const[i,o,a]=e,c=Ee(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),re.waitFor(r).next((()=>this.Dn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Se(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new et(M);return Fi(e).X({range:i},((e,t,s)=>{const[i,a,c]=e,u=Ee(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Dn(e,o)))}Dn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Ri(e).get(t).next((e=>{if(null===e)throw w();v(e.userId===this.userId),n.push(qs(this.serializer,e))})))})),re.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ni(e.ht,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Cn(t.batchId)})),re.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Cn(e){delete this.Vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return re.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return Fi(e).X({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Ee(e[1]);r.push(t)}else n.done()})).next((()=>{v(0===r.length)}))}))}containsKey(e,t){return ki(e,this.userId,t)}xn(e){return Vi(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function ki(e,t,n){const r=Se(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Fi(e).X({range:i,Y:!0},((e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Ri(e){return Qe(e,"mutations")}function Fi(e){return Qe(e,"documentMutations")}function Vi(e){return Qe(e,"mutationQueues")}class Mi{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static kn(){return new Mi(0)}static Mn(){return new Mi(-1)}}class Li{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.$n(e).next((t=>{const n=new Mi(t.highestTargetId);return t.highestTargetId=n.next(),this.On(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.$n(e).next((e=>q.fromTimestamp(new P(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.$n(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.$n(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.On(e,r))))}addTargetData(e,t){return this.Fn(e,t).next((()=>this.$n(e).next((n=>(n.targetCount+=1,this.Bn(t,n),this.On(e,n))))))}updateTargetData(e,t){return this.Fn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Oi(e).delete(t.targetId))).next((()=>this.$n(e))).next((t=>(v(t.targetCount>0),t.targetCount-=1,this.On(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Oi(e).X(((i,o)=>{const a=Us(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>re.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Oi(e).X(((e,n)=>{const r=Us(n);t(r)}))}$n(e){return Pi(e).get("targetGlobalKey").next((e=>(v(null!==e),e)))}On(e,t){return Pi(e).put("targetGlobalKey",t)}Fn(e,t){return Oi(e).put(Bs(this.serializer,t))}Bn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.$n(e).next((e=>e.targetCount))}getTargetData(e,t){const n=fn(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Oi(e).X({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=Us(n);mn(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=qi(e);return t.forEach((t=>{const i=ve(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),re.waitFor(r)}removeMatchingKeys(e,t,n){const r=qi(e);return re.forEach(t,(t=>{const s=ve(t.path);return re.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=qi(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=qi(e);let s=Wn();return r.X({range:n,Y:!0},((e,t,n)=>{const r=Ee(e[1]),i=new K(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=ve(t.path),r=IDBKeyRange.bound([n],[O(n)],!1,!0);let s=0;return qi(e).X({index:"documentTargetsIndex",Y:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}le(e,t){return Oi(e).get(t).next((e=>e?Us(e):null))}}function Oi(e){return Qe(e,"targets")}function Pi(e){return Qe(e,"targetGlobal")}function qi(e){return Qe(e,"targetDocuments")}function Ui([e,t],[n,r]){const s=M(e,n);return 0===s?M(t,r):s}class Bi{constructor(e){this.Ln=e,this.buffer=new et(Ui),this.qn=0}Un(){return++this.qn}Kn(e){const t=[e,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Ui(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Gi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(e){m("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ce(e)?m("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ne(e)}await this.Qn(3e5)}))}}class zi{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.zn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return re.resolve(ge.ct);const n=new Bi(t);return this.jn.forEachTarget(e,(e=>n.Kn(e.sequenceNumber))).next((()=>this.jn.Wn(e,(e=>n.Kn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector","Garbage collection skipped; disabled"),re.resolve(_i)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(m("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),_i):this.Hn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Hn(e,t){let n,r,s,o,a,c,u;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(m("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),d()<=i.$b.DEBUG&&m("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-l}ms`),re.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class Ki{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new zi(e,t)}(this,t)}zn(e){const t=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Jn(e){let t=0;return this.Wn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Wn(e,t){return this.Yn(e,((e,n)=>t(n)))}addReference(e,t,n){return $i(e,n)}removeReference(e,t,n){return $i(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return $i(e,t)}Xn(e,t){return function(e,t){let n=!1;return Vi(e).Z((r=>ki(e,r,t).next((e=>(e&&(n=!0),re.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Yn(e,((i,o)=>{if(o<=t){const t=this.Xn(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,q.min()),qi(e).delete([0,ve(i.path)]))))}));r.push(t)}})).next((()=>re.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return $i(e,t)}Yn(e,t){const n=qi(e);let r,s=ge.ct;return n.X({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==ge.ct&&t(new K(Ee(r)),s),s=o,r=i):s=ge.ct})).next((()=>{s!==ge.ct&&t(new K(Ee(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function $i(e,t){return qi(e).put(function(e,t){return{targetId:0,path:ve(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class ji{constructor(){this.changes=new On((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,qt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?re.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Qi{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Xi(e).put(n)}removeEntry(e,t,n){return Xi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Ls(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Zn(e,n))))}getEntry(e,t){let n=qt.newInvalidDocument(t);return Xi(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Ji(t))},((e,r)=>{n=this.ts(t,r)})).next((()=>n))}es(e,t){let n={size:0,document:qt.newInvalidDocument(t)};return Xi(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(Ji(t))},((e,r)=>{n={document:this.ts(t,r),size:Ci(r)}})).next((()=>n))}getEntries(e,t){let n=qn();return this.ns(e,t,((e,t)=>{const r=this.ts(e,t);n=n.insert(e,r)})).next((()=>n))}ss(e,t){let n=qn(),r=new Xe(K.comparator);return this.ns(e,t,((e,t)=>{const s=this.ts(e,t);n=n.insert(e,s),r=r.insert(e,Ci(t))})).next((()=>({documents:n,rs:r})))}ns(e,t,n){if(t.isEmpty())return re.resolve();let r=new et(eo);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(Ji(r.first()),Ji(r.last())),i=r.getIterator();let o=i.getNext();return Xi(e).X({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=K.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&eo(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.G(Ji(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r){const s=t.path,i=[s.popLast().toArray(),s.lastSegment(),Ls(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Xi(e).j(IDBKeyRange.bound(i,o,!0)).next((e=>{let n=qn();for(const s of e){const e=this.ts(K.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Fn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=qn();const i=Zi(t,n),o=Zi(t,J.max());return Xi(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.ts(K.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new Hi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Yi(e).get("remoteDocumentGlobalKey").next((e=>(v(!!e),e)))}Zn(e,t){return Yi(e).put("remoteDocumentGlobalKey",t)}ts(e,t){if(t){const e=function(e,t){let n;if(t.document)n=ws(e.fe,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=K.fromSegments(t.noDocument.path),r=Ps(t.noDocument.readTime);n=qt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return w();{const e=K.fromSegments(t.unknownDocument.path),r=Ps(t.unknownDocument.version);n=qt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new P(e[0],e[1]);return q.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(q.min()))return e}return qt.newInvalidDocument(e)}}function Wi(e){return new Qi(e)}class Hi extends ji{constructor(e,t){super(),this.os=e,this.trackRemovals=t,this.us=new On((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new et(((e,t)=>M(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.us.get(s);if(t.push(this.os.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Ms(this.os.serializer,i);r=r.add(s.path.popLast());const c=Ci(a);n+=c-o.size,t.push(this.os.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Ms(this.os.serializer,i.convertToNoDocument(q.min()));t.push(this.os.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.os.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.os.updateMetadata(e,n)),re.waitFor(t)}getFromCache(e,t){return this.os.es(e,t).next((e=>(this.us.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.os.ss(e,t).next((({documents:e,rs:t})=>(t.forEach(((t,n)=>{this.us.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Yi(e){return Qe(e,"remoteDocumentGlobal")}function Xi(e){return Qe(e,"remoteDocumentsV14")}function Ji(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Zi(e,t){const n=t.documentKey.path.toArray();return[e,Ls(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function eo(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=M(n[e],r[e]),s)return s;return s=M(n.length,r.length),s||(s=M(n[n.length-2],r[r.length-2]),s||M(n[n.length-1],r[r.length-1]))}class to{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class no{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&vr(n.mutation,e,rt.empty(),P.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,Wn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=Wn()){const r=zn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Bn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=zn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,Wn())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=qn();const i=$n(),o=$n();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof Tr)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),vr(o.mutation,t,o.mutation.getFieldMask(),P.now())):i.set(t.key,rt.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new to(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=$n();let r=new Xe(((e,t)=>e-t)),s=Wn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||rt.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||Wn()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=Kn();c.forEach((e=>{if(!s.has(e)){const r=yr(t.get(e),n.get(e));null!==r&&u.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return re.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return K.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):xn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):re.resolve(zn());let o=-1,a=s;return i.next((t=>re.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?re.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,Wn()))).next((e=>({batchId:o,changes:Gn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new K(t)).next((e=>{let t=Bn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let s=Bn();return this.indexManager.getCollectionParents(e,r).next((i=>re.forEach(i,(i=>{const o=function(e,t){return new vn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((s=>(r=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,r)))).next((e=>{r.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,qt.newInvalidDocument(r)))}));let n=Bn();return e.forEach(((e,s)=>{const i=r.get(e);void 0!==i&&vr(i.mutation,s,rt.empty(),P.now()),Fn(t,s)&&(n=n.insert(e,s))})),n}))}}class ro{constructor(e){this.serializer=e,this.cs=new Map,this.hs=new Map}getBundleMetadata(e,t){return re.resolve(this.cs.get(t))}saveBundleMetadata(e,t){var n;return this.cs.set(t.id,{id:(n=t).id,version:n.version,createTime:cs(n.createTime)}),re.resolve()}getNamedQuery(e,t){return re.resolve(this.hs.get(t))}saveNamedQuery(e,t){return this.hs.set(t.name,function(e){return{name:e.name,query:Gs(e.bundledQuery),readTime:cs(e.readTime)}}(t)),re.resolve()}}class so{constructor(){this.overlays=new Xe(K.comparator),this.ls=new Map}getOverlay(e,t){return re.resolve(this.overlays.get(t))}getOverlays(e,t){const n=zn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.we(e,t,r)})),re.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.ls.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.ls.delete(n)),re.resolve()}getOverlaysForCollection(e,t,n){const r=zn(),s=t.length+1,i=new K(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return re.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Xe(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=zn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=zn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return re.resolve(o)}we(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.ls.get(r.largestBatchId).delete(n.key);this.ls.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new kr(t,n));let s=this.ls.get(t);void 0===s&&(s=Wn(),this.ls.set(t,s)),this.ls.set(t,s.add(n.key))}}class io{constructor(){this.fs=new et(oo.ds),this.ws=new et(oo._s)}isEmpty(){return this.fs.isEmpty()}addReference(e,t){const n=new oo(e,t);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.ys(new oo(e,t))}ps(e,t){e.forEach((e=>this.removeReference(e,t)))}Is(e){const t=new K(new B([])),n=new oo(t,e),r=new oo(t,e+1),s=[];return this.ws.forEachInRange([n,r],(e=>{this.ys(e),s.push(e.key)})),s}Ts(){this.fs.forEach((e=>this.ys(e)))}ys(e){this.fs=this.fs.delete(e),this.ws=this.ws.delete(e)}Es(e){const t=new K(new B([])),n=new oo(t,e),r=new oo(t,e+1);let s=Wn();return this.ws.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new oo(e,0),n=this.fs.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class oo{constructor(e,t){this.key=e,this.As=t}static ds(e,t){return K.comparator(e.key,t.key)||M(e.As,t.As)}static _s(e,t){return M(e.As,t.As)||K.comparator(e.key,t.key)}}class ao{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.vs=1,this.Rs=new et(oo.ds)}checkEmpty(e){return re.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.vs;this.vs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Cr(s,t,n,r);this.mutationQueue.push(i);for(const t of r)this.Rs=this.Rs.add(new oo(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return re.resolve(i)}lookupMutationBatch(e,t){return re.resolve(this.Ps(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.bs(n),s=r<0?0:r;return re.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return re.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(e){return re.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new oo(t,0),r=new oo(t,Number.POSITIVE_INFINITY),s=[];return this.Rs.forEachInRange([n,r],(e=>{const t=this.Ps(e.As);s.push(t)})),re.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new et(M);return t.forEach((e=>{const t=new oo(e,0),r=new oo(e,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([t,r],(e=>{n=n.add(e.As)}))})),re.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;K.isDocumentKey(s)||(s=s.child(""));const i=new oo(new K(s),0);let o=new et(M);return this.Rs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.As)),!0)}),i),re.resolve(this.Vs(o))}Vs(e){const t=[];return e.forEach((e=>{const n=this.Ps(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){v(0===this.Ss(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return re.forEach(t.mutations,(r=>{const s=new oo(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.Rs=n}))}Cn(e){}containsKey(e,t){const n=new oo(t,0),r=this.Rs.firstAfterOrEqual(n);return re.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,re.resolve()}Ss(e,t){return this.bs(e)}bs(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Ps(e){const t=this.bs(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class co{constructor(e){this.Ds=e,this.docs=new Xe(K.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Ds(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return re.resolve(n?n.document.mutableCopy():qt.newInvalidDocument(t))}getEntries(e,t){let n=qn();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():qt.newInvalidDocument(e))})),re.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=qn();const i=t.path,o=new K(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||Z(X(o),n)<=0||(r.has(o.key)||Fn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return re.resolve(s)}getAllFromCollectionGroup(e,t,n,r){w()}Cs(e,t){return re.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new uo(this)}getSize(e){return re.resolve(this.size)}}class uo extends ji{constructor(e){super(),this.os=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.os.addEntry(e,r)):this.os.removeEntry(n)})),re.waitFor(t)}getFromCache(e,t){return this.os.getEntry(e,t)}getAllFromCache(e,t){return this.os.getEntries(e,t)}}class lo{constructor(e){this.persistence=e,this.xs=new On((e=>fn(e)),mn),this.lastRemoteSnapshotVersion=q.min(),this.highestTargetId=0,this.Ns=0,this.ks=new io,this.targetCount=0,this.Ms=Mi.kn()}forEachTarget(e,t){return this.xs.forEach(((e,n)=>t(n))),re.resolve()}getLastRemoteSnapshotVersion(e){return re.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return re.resolve(this.Ns)}allocateTargetId(e){return this.highestTargetId=this.Ms.next(),re.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Ns&&(this.Ns=t),re.resolve()}Fn(e){this.xs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Ms=new Mi(t),this.highestTargetId=t),e.sequenceNumber>this.Ns&&(this.Ns=e.sequenceNumber)}addTargetData(e,t){return this.Fn(t),this.targetCount+=1,re.resolve()}updateTargetData(e,t){return this.Fn(t),re.resolve()}removeTargetData(e,t){return this.xs.delete(t.target),this.ks.Is(t.targetId),this.targetCount-=1,re.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.xs.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.xs.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),re.waitFor(s).next((()=>r))}getTargetCount(e){return re.resolve(this.targetCount)}getTargetData(e,t){const n=this.xs.get(t)||null;return re.resolve(n)}addMatchingKeys(e,t,n){return this.ks.gs(t,n),re.resolve()}removeMatchingKeys(e,t,n){this.ks.ps(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),re.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.ks.Is(t),re.resolve()}getMatchingKeysForTargetId(e,t){const n=this.ks.Es(t);return re.resolve(n)}containsKey(e,t){return re.resolve(this.ks.containsKey(t))}}class ho{constructor(e,t){this.$s={},this.overlays={},this.Os=new ge(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=e(this),this.Bs=new lo(this),this.indexManager=new yi,this.remoteDocumentCache=function(e){return new co(e)}((e=>this.referenceDelegate.Ls(e))),this.serializer=new Vs(t),this.qs=new ro(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new so,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.$s[e.toKey()];return n||(n=new ao(t,this.referenceDelegate),this.$s[e.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(e,t,n){m("MemoryPersistence","Starting transaction:",e);const r=new fo(this.Os.next());return this.referenceDelegate.Us(),n(r).next((e=>this.referenceDelegate.Ks(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gs(e,t){return re.or(Object.values(this.$s).map((n=>()=>n.containsKey(e,t))))}}class fo extends te{constructor(e){super(),this.currentSequenceNumber=e}}class mo{constructor(e){this.persistence=e,this.Qs=new io,this.js=null}static zs(e){return new mo(e)}get Ws(){if(this.js)return this.js;throw w()}addReference(e,t,n){return this.Qs.addReference(n,t),this.Ws.delete(n.toString()),re.resolve()}removeReference(e,t,n){return this.Qs.removeReference(n,t),this.Ws.add(n.toString()),re.resolve()}markPotentiallyOrphaned(e,t){return this.Ws.add(t.toString()),re.resolve()}removeTarget(e,t){this.Qs.Is(t.targetId).forEach((e=>this.Ws.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ws.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Us(){this.js=new Set}Ks(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return re.forEach(this.Ws,(n=>{const r=K.fromPath(n);return this.Hs(e,r).next((e=>{e||t.removeEntry(r,q.min())}))})).next((()=>(this.js=null,t.apply(e))))}updateLimboDocument(e,t){return this.Hs(e,t).next((e=>{e?this.Ws.delete(t.toString()):this.Ws.add(t.toString())}))}Ls(e){return 0}Hs(e,t){return re.or([()=>re.resolve(this.Qs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gs(e,t)])}}class go{constructor(e){this.serializer=e}O(e,t,n,r){const s=new se("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Te,{unique:!0}),e.createObjectStore("documentMutations")}(e),po(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=re.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),po(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:q.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").j().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Te,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return re.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Ys(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Xs(s))))),n<7&&r>=7&&(i=i.next((()=>this.Zs(s)))),n<8&&r>=8&&(i=i.next((()=>this.ti(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.ei(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Pe});t.createIndex("collectionPathOverlayIndex",qe,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Ue,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:De});t.createIndex("documentKeyIndex",Ne),t.createIndex("collectionGroupIndex",Ce)}(e))).next((()=>this.ni(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Ve}).createIndex("sequenceNumberIndex",Me,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Le}).createIndex("documentKeyIndex",Oe,{unique:!1})}(e)))),i}Xs(e){let t=0;return e.store("remoteDocuments").X(((e,n)=>{t+=Ci(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Ys(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.j().next((t=>re.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",r).next((n=>re.forEach(n,(n=>{v(n.userId===t.userId);const r=qs(this.serializer,n);return Ni(e,t.userId,r).next((()=>{}))}))))}))))}Zs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.X(((n,s)=>{const i=new B(n),o=function(e){return[0,ve(e)]}(i);r.push(t.get(o).next((n=>n?re.resolve():(n=>t.put({targetId:0,path:ve(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>re.waitFor(r)))}))}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Fe});const n=t.store("collectionParents"),r=new wi,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:ve(r)})}};return t.store("remoteDocuments").X({Y:!0},((e,t)=>{const n=new B(e);return s(n.popLast())})).next((()=>t.store("documentMutations").X({Y:!0},(([e,t,n],r)=>{const i=Ee(t);return s(i.popLast())}))))}ei(e){const t=e.store("targets");return t.X(((e,n)=>{const r=Us(n),s=Bs(this.serializer,r);return t.put(s)}))}ni(e,t){const n=t.store("remoteDocuments"),r=[];return n.X(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new K(B.fromString(o.document.name).popFirst(5)):o.noDocument?K.fromSegments(o.noDocument.path):o.unknownDocument?K.fromSegments(o.unknownDocument.path):w()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>re.waitFor(r)))}si(e,t){const n=t.store("mutations"),r=Wi(this.serializer),s=new ho(mo.zs,this.serializer.fe);return n.j().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:Wn();qs(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),re.forEach(n,((e,n)=>{const i=new u(n),o=Hs.de(this.serializer,i),a=s.getIndexManager(i),c=Ai.de(i,this.serializer,a,s.referenceDelegate);return new no(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new je(t,ge.ct),e).next()}))}))}}function po(e){e.createObjectStore("targetDocuments",{keyPath:ke}).createIndex("documentTargetsIndex",Re,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ae,{unique:!0}),e.createObjectStore("targetGlobal")}const yo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class wo{constructor(e,t,n,r,s,i,o,a,c,u,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=s,this.window=i,this.document=o,this.ri=c,this.oi=u,this.ui=l,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!wo.D())throw new T(E.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ki(this,r),this.di=t+"main",this.serializer=new Vs(a),this.wi=new ie(this.di,this.ui,new go(this.serializer)),this.Bs=new Li(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Wi(this.serializer),this.qs=new js,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===u&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new T(E.FAILED_PRECONDITION,yo);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Bs.getHighestSequenceNumber(e)))})).then((e=>{this.Os=new ge(e,this.ri)})).then((()=>{this.Fs=!0})).catch((e=>(this.wi&&this.wi.close(),Promise.reject(e))))}Ii(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.wi.B((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Io(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Ti(e).next((e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Ei(e))).next((t=>this.isPrimary&&!t?this.Ai(e).next((()=>!1)):!!t&&this.vi(e).next((()=>!0)))))).catch((e=>{if(ce(e))return m("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return m("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.ii.enqueueRetryable((()=>this.fi(e))),this.isPrimary=e}))}Ti(e){return vo(e).get("owner").next((e=>re.resolve(this.Ri(e))))}Pi(e){return Io(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Qe(e,"clientMetadata");return t.j().next((e=>{const n=this.Si(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return re.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this._i)for(const t of e)this._i.removeItem(this.Di(t.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.bi())).then((()=>this.pi()))))}Ri(e){return!!e&&e.ownerId===this.clientId}Ei(e){return this.oi?re.resolve(!0):vo(e).get("owner").next((t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)){if(this.Ri(t)&&this.networkEnabled)return!0;if(!this.Ri(t)){if(!t.allowTabSynchronization)throw new T(E.FAILED_PRECONDITION,yo);return!1}}return!(!this.networkEnabled||!this.inForeground)||Io(e).j().next((e=>void 0===this.Si(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&m("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new je(e,ge.ct);return this.Ai(t).next((()=>this.Pi(t)))})),this.wi.close(),this.Mi()}Si(e,t){return e.filter((e=>this.Vi(e.updateTimeMs,t)&&!this.Ci(e.clientId)))}$i(){return this.runTransaction("getActiveClients","readonly",(e=>Io(e).j().next((e=>this.Si(e,18e5).map((e=>e.clientId))))))}get started(){return this.Fs}getMutationQueue(e,t){return Ai.de(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Ii(e,this.serializer.fe.databaseId)}getDocumentOverlayCache(e){return Hs.de(this.serializer,e)}getBundleCache(){return this.qs}runTransaction(e,t,n){m("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=15===(i=this.ui)?$e:14===i?Ke:13===i?ze:12===i?Ge:11===i?Be:void w();var i;let o;return this.wi.runTransaction(e,r,s,(r=>(o=new je(r,this.Os?this.Os.next():ge.ct),"readwrite-primary"===t?this.Ti(o).next((e=>!!e||this.Ei(o))).next((t=>{if(!t)throw g(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))),new T(E.FAILED_PRECONDITION,ee);return n(o)})).next((e=>this.vi(o).next((()=>e)))):this.Oi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Oi(e){return vo(e).get("owner").next((e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.Ri(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new T(E.FAILED_PRECONDITION,yo)}))}vi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return vo(e).put("owner",t)}static D(){return ie.D()}Ai(e){const t=vo(e);return t.get("owner").next((e=>this.Ri(e)?(m("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):re.resolve()))}Vi(e,t){const n=Date.now();return!(e<n-t||e>n&&(g(`Detected an update time that is in the future: ${e} > ${n}`),1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;(0,o.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(e){var t;try{const n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Di(e)));return m("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(e){}}Di(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function vo(e){return Qe(e,"owner")}function Io(e){return Qe(e,"clientMetadata")}function bo(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Eo{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Fi=n,this.Bi=r}static Li(e,t){let n=Wn(),r=Wn();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new Eo(e,t.fromCache,n,r)}}class To{constructor(){this.qi=!1}initialize(e,t){this.Ui=e,this.indexManager=t,this.qi=!0}getDocumentsMatchingQuery(e,t,n,r){return this.Ki(e,t).next((s=>s||this.Gi(e,t,r,n))).next((n=>n||this.Qi(e,t)))}Ki(e,t){if(En(t))return re.resolve(null);let n=Dn(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Cn(t,null,"F"),n=Dn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=Wn(...r);return this.Ui.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.ji(t,r);return this.zi(t,i,s,n.readTime)?this.Ki(e,Cn(t,null,"F")):this.Wi(e,i,t,n)}))))})))))}Gi(e,t,n,r){return En(t)||r.isEqual(q.min())?this.Qi(e,t):this.Ui.getDocuments(e,n).next((s=>{const o=this.ji(t,s);return this.zi(t,o,n,r)?this.Qi(e,t):(d()<=i.$b.DEBUG&&m("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),Rn(t)),this.Wi(e,o,t,Y(r,-1)))}))}ji(e,t){let n=new et(Mn(e));return t.forEach(((t,r)=>{Fn(e,r)&&(n=n.add(r))})),n}zi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Qi(e,t){return d()<=i.$b.DEBUG&&m("QueryEngine","Using full collection scan to execute query:",Rn(t)),this.Ui.getDocumentsMatchingQuery(e,t,J.min())}Wi(e,t,n,r){return this.Ui.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class So{constructor(e,t,n,r){this.persistence=e,this.Hi=t,this.serializer=r,this.Ji=new Xe(M),this.Yi=new On((e=>fn(e)),mn),this.Xi=new Map,this.Zi=e.getRemoteDocumentCache(),this.Bs=e.getTargetCache(),this.qs=e.getBundleCache(),this.tr(n)}tr(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new no(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ji)))}}function xo(e,t,n,r){return new So(e,t,n,r)}async function _o(e,t){const n=b(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.tr(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=Wn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({er:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Do(e){const t=b(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Bs.getLastRemoteSnapshotVersion(e)))}function No(e,t,n){let r=Wn(),s=Wn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=qn();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(q.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):m("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{nr:r,sr:s}}))}function Co(e,t){const n=b(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Ao(e,t){const n=b(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Bs.getTargetData(e,t).next((s=>s?(r=s,re.resolve(r)):n.Bs.allocateTargetId(e).next((s=>(r=new Fs(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Bs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.Ji.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.Ji=n.Ji.insert(e.targetId,e),n.Yi.set(t,e.targetId)),e}))}async function ko(e,t,n){const r=b(e),s=r.Ji.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ce(e))throw e;m("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.Ji=r.Ji.remove(t),r.Yi.delete(s.target)}function Ro(e,t,n){const r=b(e);let s=q.min(),i=Wn();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=b(e),s=r.Yi.get(n);return void 0!==s?re.resolve(r.Ji.get(s)):r.Bs.getTargetData(t,n)}(r,e,Dn(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Bs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Hi.getDocumentsMatchingQuery(e,t,n?s:q.min(),n?i:Wn()))).next((e=>(Mo(r,Vn(t),e),{documents:e,ir:i})))))}function Fo(e,t){const n=b(e),r=b(n.Bs),s=n.Ji.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.le(e,t).next((e=>e?e.target:null))))}function Vo(e,t){const n=b(e),r=n.Xi.get(t)||q.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Zi.getAllFromCollectionGroup(e,t,Y(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Mo(n,t,e),e)))}function Mo(e,t,n){let r=e.Xi.get(t)||q.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Xi.set(t,r)}async function Lo(e,t,n=Wn()){const r=await Ao(e,Dn(Gs(t.bundledQuery))),s=b(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=cs(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.qs.saveNamedQuery(e,t);const o=r.withResumeToken(ot.EMPTY_BYTE_STRING,i);return s.Ji=s.Ji.insert(o.targetId,o),s.Bs.updateTargetData(e,o).next((()=>s.Bs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Bs.addMatchingKeys(e,n,r.targetId))).next((()=>s.qs.saveNamedQuery(e,t)))}))}function Oo(e,t){return`firestore_clients_${e}_${t}`}function Po(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function qo(e,t){return`firestore_targets_${e}_${t}`}class Uo{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static ar(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new T(r.error.code,r.error.message))),i?new Uo(e,t,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Bo{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static ar(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new T(n.error.code,n.error.message))),s?new Bo(e,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Go{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static ar(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Yn();for(let e=0;r&&e<n.activeTargetIds.length;++e)r=we(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new Go(e,s):(g("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class zo{constructor(e,t){this.clientId=e,this.onlineState=t}static ar(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new zo(t.clientId,t.onlineState):(g("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Ko{constructor(){this.activeTargetIds=Yn()}lr(e){this.activeTargetIds=this.activeTargetIds.add(e)}dr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}hr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class $o{constructor(e,t,n,r,s){this.window=e,this.ii=t,this.persistenceKey=n,this.wr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this._r=this.mr.bind(this),this.gr=new Xe(M),this.started=!1,this.yr=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.pr=Oo(this.persistenceKey,this.wr),this.Ir=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.gr=this.gr.insert(this.wr,new Ko),this.Tr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Er=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Ar=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Rr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this._r)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.$i();for(const t of e){if(t===this.wr)continue;const e=this.getItem(Oo(this.persistenceKey,t));if(e){const n=Go.ar(t,e);n&&(this.gr=this.gr.insert(n.clientId,n))}}this.Pr();const t=this.storage.getItem(this.vr);if(t){const e=this.br(t);e&&this.Vr(e)}for(const e of this.yr)this.mr(e);this.yr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ir,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Sr(this.gr)}isActiveQueryTarget(e){let t=!1;return this.gr.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Dr(e,"pending")}updateMutationState(e,t,n){this.Dr(e,t,n),this.Cr(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(qo(this.persistenceKey,e));if(n){const r=Bo.ar(e,n);r&&(t=r.state)}}return this.Nr.lr(e),this.Pr(),t}removeLocalQueryTarget(e){this.Nr.dr(e),this.Pr()}isLocalQueryTarget(e){return this.Nr.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(qo(this.persistenceKey,e))}updateQueryState(e,t,n){this.kr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Cr(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Mr(e)}notifyBundleLoaded(e){this.$r(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this._r),this.removeItem(this.pr),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return m("SharedClientState","READ",e,t),t}setItem(e,t){m("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){m("SharedClientState","REMOVE",e),this.storage.removeItem(e)}mr(e){const t=e;if(t.storageArea===this.storage){if(m("SharedClientState","EVENT",t.key,t.newValue),t.key===this.pr)return void g("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ii.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Tr.test(t.key)){if(null==t.newValue){const e=this.Or(t.key);return this.Fr(e,null)}{const e=this.Br(t.key,t.newValue);if(e)return this.Fr(e.clientId,e)}}else if(this.Er.test(t.key)){if(null!==t.newValue){const e=this.Lr(t.key,t.newValue);if(e)return this.qr(e)}}else if(this.Ar.test(t.key)){if(null!==t.newValue){const e=this.Ur(t.key,t.newValue);if(e)return this.Kr(e)}}else if(t.key===this.vr){if(null!==t.newValue){const e=this.br(t.newValue);if(e)return this.Vr(e)}}else if(t.key===this.Ir){const e=function(e){let t=ge.ct;if(null!=e)try{const n=JSON.parse(e);v("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ge.ct&&this.sequenceNumberHandler(e)}else if(t.key===this.Rr){const e=this.Gr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Qr(e))))}}else this.yr.push(t)}))}}get Nr(){return this.gr.get(this.wr)}Pr(){this.setItem(this.pr,this.Nr.hr())}Dr(e,t,n){const r=new Uo(this.currentUser,e,t,n),s=Po(this.persistenceKey,this.currentUser,e);this.setItem(s,r.hr())}Cr(e){const t=Po(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Mr(e){const t={clientId:this.wr,onlineState:e};this.storage.setItem(this.vr,JSON.stringify(t))}kr(e,t,n){const r=qo(this.persistenceKey,e),s=new Bo(e,t,n);this.setItem(r,s.hr())}$r(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Rr,t)}Or(e){const t=this.Tr.exec(e);return t?t[1]:null}Br(e,t){const n=this.Or(e);return Go.ar(n,t)}Lr(e,t){const n=this.Er.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Uo.ar(new u(s),r,t)}Ur(e,t){const n=this.Ar.exec(e),r=Number(n[1]);return Bo.ar(r,t)}br(e){return zo.ar(e)}Gr(e){return JSON.parse(e)}async qr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.jr(e.batchId,e.state,e.error);m("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Kr(e){return this.syncEngine.zr(e.targetId,e.state,e.error)}Fr(e,t){const n=t?this.gr.insert(e,t):this.gr.remove(e),r=this.Sr(this.gr),s=this.Sr(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Wr(i,o).then((()=>{this.gr=n}))}Vr(e){this.gr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Sr(e){let t=Yn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class jo{constructor(){this.Hr=new Ko,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hr.lr(e),this.Jr[e]||"not-current"}updateQueryState(e,t,n){this.Jr[e]=t}removeLocalQueryTarget(e){this.Hr.dr(e)}isLocalQueryTarget(e){return this.Hr.activeTargetIds.has(e)}clearQueryState(e){delete this.Jr[e]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(e){return this.Hr.activeTargetIds.has(e)}start(){return this.Hr=new Ko,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Qo{Yr(e){}shutdown(){}}class Wo{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(e){this.so.push(e)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){m("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.so)e(0)}no(){m("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.so)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Ho=null;function Yo(){return null===Ho?Ho=268435456+Math.round(2147483648*Math.random()):Ho++,"0x"+Ho.toString(16)}const Xo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Jo{constructor(e){this.ro=e.ro,this.oo=e.oo}uo(e){this.co=e}ao(e){this.ho=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.ro(e)}fo(){this.co()}wo(e){this.ho(e)}_o(e){this.lo(e)}}const Zo="WebChannelConnection";class ea extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.mo=t+"://"+e.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(e,t,n,r,s){const i=Yo(),o=this.To(e,t);m("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={};return this.Eo(a,r,s),this.Ao(e,o,a,n).then((t=>(m("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw p("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}vo(e,t,n,r,s,i){return this.Io(e,t,n,r,s)}Eo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}To(e,t){const n=Xo[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Ao(e,t,n,r){const s=Yo();return new Promise(((i,o)=>{const c=new a.ZS;c.setWithCredentials(!0),c.listenOnce(a.Bx.COMPLETE,(()=>{try{switch(c.getLastErrorCode()){case a.O4.NO_ERROR:const t=c.getResponseJson();m(Zo,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case a.O4.TIMEOUT:m(Zo,`RPC '${e}' ${s} timed out`),o(new T(E.DEADLINE_EXCEEDED,"Request time out"));break;case a.O4.HTTP_ERROR:const n=c.getStatus();if(m(Zo,`RPC '${e}' ${s} failed with status:`,n,"response text:",c.getResponseText()),n>0){let e=c.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(E).indexOf(t)>=0?t:E.UNKNOWN}(t.status);o(new T(e,t.message))}else o(new T(E.UNKNOWN,"Server responded with status "+c.getStatus()))}else o(new T(E.UNAVAILABLE,"Connection failed."));break;default:w()}}finally{m(Zo,`RPC '${e}' ${s} completed.`)}}));const u=JSON.stringify(r);m(Zo,`RPC '${e}' ${s} sending request:`,r),c.send(t,"POST",u,n,15)}))}Ro(e,t,n){const r=Yo(),s=[this.mo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=(0,a.fF)(),o=(0,a.Ao)(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(c.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(c.xmlHttpFactory=new a._L({})),this.Eo(c.initMessageHeaders,t,n),c.encodeInitMessageHeaders=!0;const l=s.join("");m(Zo,`Creating RPC '${e}' stream ${r}: ${l}`,c);const h=i.createWebChannel(l,c);let d=!1,f=!1;const g=new Jo({ro:t=>{f?m(Zo,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(m(Zo,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),m(Zo,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},oo:()=>h.close()}),y=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return y(h,a.iO.EventType.OPEN,(()=>{f||m(Zo,`RPC '${e}' stream ${r} transport opened.`)})),y(h,a.iO.EventType.CLOSE,(()=>{f||(f=!0,m(Zo,`RPC '${e}' stream ${r} transport closed`),g.wo())})),y(h,a.iO.EventType.ERROR,(t=>{f||(f=!0,p(Zo,`RPC '${e}' stream ${r} transport errored:`,t),g.wo(new T(E.UNAVAILABLE,"The operation could not be completed")))})),y(h,a.iO.EventType.MESSAGE,(t=>{var n;if(!f){const s=t.data[0];v(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){m(Zo,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=Fr[e];if(void 0!==t)return Lr(t)}(t),s=o.message;void 0===n&&(n=E.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),f=!0,g.wo(new T(n,s)),h.close()}else m(Zo,`RPC '${e}' stream ${r} received:`,s),g._o(s)}})),y(o,a.Jh.STAT_EVENT,(t=>{t.stat===a.ro.PROXY?m(Zo,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===a.ro.NOPROXY&&m(Zo,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{g.fo()}),0),g}}function ta(){return"undefined"!=typeof window?window:null}function na(){return"undefined"!=typeof document?document:null}function ra(e){return new rs(e,!0)}class sa{constructor(e,t,n=1e3,r=1.5,s=6e4){this.ii=e,this.timerId=t,this.Po=n,this.bo=r,this.Vo=s,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(e){this.cancel();const t=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),r=Math.max(0,t-n);r>0&&m("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.So} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,r,(()=>(this.Co=Date.now(),e()))),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class ia{constructor(e,t,n,r,s,i,o,a){this.ii=e,this.$o=n,this.Oo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new sa(e,t)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,(()=>this.zo())))}Wo(e){this.Ho(),this.stream.send(e)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(e,t){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==e?this.qo.reset():t&&t.code===E.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):t&&t.code===E.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.ao(t)}Yo(){}auth(){this.state=1;const e=this.Xo(this.Fo),t=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Fo===t&&this.Zo(e,n)}),(t=>{e((()=>{const e=new T(E.UNKNOWN,"Fetching auth token failed: "+t.message);return this.tu(e)}))}))}Zo(e,t){const n=this.Xo(this.Fo);this.stream=this.eu(e,t),this.stream.uo((()=>{n((()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,(()=>(this.Ko()&&(this.state=3),Promise.resolve()))),this.listener.uo())))})),this.stream.ao((e=>{n((()=>this.tu(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Go(){this.state=5,this.qo.No((async()=>{this.state=0,this.start()}))}tu(e){return m("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(e){return t=>{this.ii.enqueueAndForget((()=>this.Fo===e?t():(m("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class oa extends ia{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}eu(e,t){return this.connection.Ro("Listen",e,t)}onMessage(e){this.qo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:w()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(v(void 0===t||"string"==typeof t),ot.fromBase64String(t||"")):(v(void 0===t||t instanceof Uint8Array),ot.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?E.UNKNOWN:Lr(e.code);return new T(t,e.message||"")}(o);n=new Hr(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=ds(e,r.document.name),i=cs(r.document.updateTime),o=r.document.createTime?cs(r.document.createTime):q.min(),a=new Ot({mapValue:{fields:r.document.fields}}),c=qt.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Qr(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=ds(e,r.document),i=r.readTime?cs(r.readTime):q.min(),o=qt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Qr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=ds(e,r.document),i=r.removedTargetIds||[];n=new Qr([],i,s,null)}else{if(!("filter"in t))return w();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Rr(r,s),o=e.targetId;n=new Wr(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return q.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?q.min():t.readTime?cs(t.readTime):q.min()}(e);return this.listener.nu(t,n)}su(e){const t={};t.database=gs(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=gn(r)?{documents:bs(e,r)}:{query:Es(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=os(e,t.resumeToken);const r=ss(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(q.min())>0){n.readTime=is(e,t.snapshotVersion.toTimestamp());const r=ss(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return w()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.Wo(t)}iu(e){const t={};t.database=gs(this.serializer),t.removeTarget=e,this.Wo(t)}}class aa extends ia{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(e,t){return this.connection.Ro("Write",e,t)}onMessage(e){if(v(!!e.streamToken),this.lastStreamToken=e.streamToken,this.ru){this.qo.reset();const t=function(e,t){return e&&e.length>0?(v(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?cs(e.updateTime):cs(t);return n.isEqual(q.min())&&(n=cs(t)),new fr(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=cs(e.commitTime);return this.listener.cu(n,t)}return v(!e.writeResults||0===e.writeResults.length),this.ru=!0,this.listener.au()}hu(){const e={};e.database=gs(this.serializer),this.Wo(e)}uu(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>vs(this.serializer,e)))};this.Wo(t)}}class ca extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.lu=!1}fu(){if(this.lu)throw new T(E.FAILED_PRECONDITION,"The client has already been terminated.")}Io(e,t,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.connection.Io(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new T(E.UNKNOWN,e.toString())}))}vo(e,t,n,r){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.vo(e,t,n,s,i,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===E.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new T(E.UNKNOWN,e.toString())}))}terminate(){this.lu=!0}}class ua{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve()))))}Iu(e){"Online"===this.state?this.yu("Unknown"):(this.wu++,this.wu>=1&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.yu("Offline")))}set(e){this.Tu(),this.wu=0,"Online"===e&&(this.mu=!1),this.yu(e)}yu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}pu(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(g(t),this.mu=!1):m("OnlineStateTracker",t)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class la{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=s,this.Pu.Yr((e=>{n.enqueueAndForget((async()=>{va(this)&&(m("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=b(e);t.vu.add(4),await da(t),t.bu.set("Unknown"),t.vu.delete(4),await ha(t)}(this))}))})),this.bu=new ua(n,r)}}async function ha(e){if(va(e))for(const t of e.Ru)await t(!0)}async function da(e){for(const t of e.Ru)await t(!1)}function fa(e,t){const n=b(e);n.Au.has(t.targetId)||(n.Au.set(t.targetId,t),wa(n)?ya(n):Oa(n).Ko()&&ga(n,t))}function ma(e,t){const n=b(e),r=Oa(n);n.Au.delete(t),r.Ko()&&pa(n,t),0===n.Au.size&&(r.Ko()?r.jo():va(n)&&n.bu.set("Unknown"))}function ga(e,t){if(e.Vu.qt(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(q.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}Oa(e).su(t)}function pa(e,t){e.Vu.qt(t),Oa(e).iu(t)}function ya(e){e.Vu=new Xr({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),le:t=>e.Au.get(t)||null,ue:()=>e.datastore.serializer.databaseId}),Oa(e).start(),e.bu.gu()}function wa(e){return va(e)&&!Oa(e).Uo()&&e.Au.size>0}function va(e){return 0===b(e).vu.size}function Ia(e){e.Vu=void 0}async function ba(e){e.Au.forEach(((t,n)=>{ga(e,t)}))}async function Ea(e,t){Ia(e),wa(e)?(e.bu.Iu(t),ya(e)):e.bu.set("Unknown")}async function Ta(e,t,n){if(e.bu.set("Online"),t instanceof Hr&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.Au.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Au.delete(r),e.Vu.removeTarget(r))}(e,t)}catch(n){m("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Sa(e,n)}else if(t instanceof Qr?e.Vu.Ht(t):t instanceof Wr?e.Vu.ne(t):e.Vu.Xt(t),!n.isEqual(q.min()))try{const t=await Do(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Vu.ce(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.Au.get(r);s&&e.Au.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.Au.get(t);if(!r)return;e.Au.set(t,r.withResumeToken(ot.EMPTY_BYTE_STRING,r.snapshotVersion)),pa(e,t);const s=new Fs(r.target,t,n,r.sequenceNumber);ga(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){m("RemoteStore","Failed to raise snapshot:",t),await Sa(e,t)}}async function Sa(e,t,n){if(!ce(t))throw t;e.vu.add(1),await da(e),e.bu.set("Offline"),n||(n=()=>Do(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{m("RemoteStore","Retrying IndexedDB access"),await n(),e.vu.delete(1),await ha(e)}))}function xa(e,t){return t().catch((n=>Sa(e,n,t)))}async function _a(e){const t=b(e),n=Pa(t);let r=t.Eu.length>0?t.Eu[t.Eu.length-1].batchId:-1;for(;Da(t);)try{const e=await Co(t.localStore,r);if(null===e){0===t.Eu.length&&n.jo();break}r=e.batchId,Na(t,e)}catch(e){await Sa(t,e)}Ca(t)&&Aa(t)}function Da(e){return va(e)&&e.Eu.length<10}function Na(e,t){e.Eu.push(t);const n=Pa(e);n.Ko()&&n.ou&&n.uu(t.mutations)}function Ca(e){return va(e)&&!Pa(e).Uo()&&e.Eu.length>0}function Aa(e){Pa(e).start()}async function ka(e){Pa(e).hu()}async function Ra(e){const t=Pa(e);for(const n of e.Eu)t.uu(n.mutations)}async function Fa(e,t,n){const r=e.Eu.shift(),s=Ar.from(r,t,n);await xa(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await _a(e)}async function Va(e,t){t&&Pa(e).ou&&await async function(e,t){if(Mr(n=t.code)&&n!==E.ABORTED){const n=e.Eu.shift();Pa(e).Qo(),await xa(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await _a(e)}var n}(e,t),Ca(e)&&Aa(e)}async function Ma(e,t){const n=b(e);n.asyncQueue.verifyOperationInProgress(),m("RemoteStore","RemoteStore received new credentials");const r=va(n);n.vu.add(3),await da(n),r&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.vu.delete(3),await ha(n)}async function La(e,t){const n=b(e);t?(n.vu.delete(2),await ha(n)):t||(n.vu.add(2),await da(n),n.bu.set("Unknown"))}function Oa(e){return e.Su||(e.Su=function(e,t,n){const r=b(e);return r.fu(),new oa(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:ba.bind(null,e),ao:Ea.bind(null,e),nu:Ta.bind(null,e)}),e.Ru.push((async t=>{t?(e.Su.Qo(),wa(e)?ya(e):e.bu.set("Unknown")):(await e.Su.stop(),Ia(e))}))),e.Su}function Pa(e){return e.Du||(e.Du=function(e,t,n){const r=b(e);return r.fu(),new aa(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{uo:ka.bind(null,e),ao:Va.bind(null,e),au:Ra.bind(null,e),cu:Fa.bind(null,e)}),e.Ru.push((async t=>{t?(e.Du.Qo(),await _a(e)):(await e.Du.stop(),e.Eu.length>0&&(m("RemoteStore",`Stopping write stream with ${e.Eu.length} pending writes`),e.Eu=[]))}))),e.Du}class qa{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new S,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new qa(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new T(E.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ua(e,t){if(g("AsyncQueue",`${t}: ${e}`),ce(e))return new T(E.UNAVAILABLE,`${t}: ${e}`);throw e}class Ba{constructor(e){this.comparator=e?(t,n)=>e(t,n)||K.comparator(t.key,n.key):(e,t)=>K.comparator(e.key,t.key),this.keyedMap=Bn(),this.sortedSet=new Xe(this.comparator)}static emptySet(e){return new Ba(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Ba))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Ba;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ga{constructor(){this.Cu=new Xe(K.comparator)}track(e){const t=e.doc.key,n=this.Cu.get(t);n?0!==e.type&&3===n.type?this.Cu=this.Cu.insert(t,e):3===e.type&&1!==n.type?this.Cu=this.Cu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Cu=this.Cu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Cu=this.Cu.remove(t):1===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):w():this.Cu=this.Cu.insert(t,e)}xu(){const e=[];return this.Cu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class za{constructor(e,t,n,r,s,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new za(e,t,Ba.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&An(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class Ka{constructor(){this.Nu=void 0,this.listeners=[]}}class $a{constructor(){this.queries=new On((e=>kn(e)),An),this.onlineState="Unknown",this.ku=new Set}}async function ja(e,t){const n=b(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new Ka),s)try{i.Nu=await n.onListen(r)}catch(e){const n=Ua(e,`Initialization of query '${Rn(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Mu(n.onlineState),i.Nu&&t.$u(i.Nu)&&Ya(n)}async function Qa(e,t){const n=b(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Wa(e,t){const n=b(e);let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.$u(e)&&(r=!0);s.Nu=e}}r&&Ya(n)}function Ha(e,t,n){const r=b(e),s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}function Ya(e){e.ku.forEach((e=>{e.next()}))}class Xa{constructor(e,t,n){this.query=e,this.Ou=t,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new za(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Fu?this.Lu(e)&&(this.Ou.next(e),t=!0):this.qu(e,this.onlineState)&&(this.Uu(e),t=!0),this.Bu=e,t}onError(e){this.Ou.error(e)}Mu(e){this.onlineState=e;let t=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,e)&&(this.Uu(this.Bu),t=!0),t}qu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Ku||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Lu(e){if(e.docChanges.length>0)return!0;const t=this.Bu&&this.Bu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Uu(e){e=za.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Fu=!0,this.Ou.next(e)}}class Ja{constructor(e,t){this.Gu=e,this.byteLength=t}Qu(){return"metadata"in this.Gu}}class Za{constructor(e){this.serializer=e}rr(e){return ds(this.serializer,e)}ur(e){return e.metadata.exists?ws(this.serializer,e.document,!1):qt.newNoDocument(this.rr(e.metadata.name),this.cr(e.metadata.readTime))}cr(e){return cs(e)}}class ec{constructor(e,t,n){this.ju=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=tc(e)}zu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Gu.namedQuery)this.queries.push(e.Gu.namedQuery);else if(e.Gu.documentMetadata){this.documents.push({metadata:e.Gu.documentMetadata}),e.Gu.documentMetadata.exists||++t;const n=B.fromString(e.Gu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Gu.document&&(this.documents[this.documents.length-1].document=e.Gu.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Wu(e){const t=new Map,n=new Za(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.rr(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||Wn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=b(e);let i=Wn(),o=qn();for(const e of n){const n=t.rr(e.metadata.name);e.document&&(i=i.add(n));const r=t.ur(e);r.setReadTime(t.cr(e.metadata.readTime)),o=o.insert(n,r)}const a=s.Zi.newChangeBuffer({trackRemovals:!0}),c=await Ao(s,function(e){return Dn(bn(B.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>No(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Bs.removeMatchingKeysForTargetId(e,c.targetId).next((()=>s.Bs.addMatchingKeys(e,i,c.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.nr,t.sr))).next((()=>t.nr))))))}(this.localStore,new Za(this.serializer),this.documents,this.ju.id),t=this.Wu(this.documents);for(const e of this.queries)await Lo(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Hu:this.collectionGroups,Ju:e}}}function tc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class nc{constructor(e){this.key=e}}class rc{constructor(e){this.key=e}}class sc{constructor(e,t){this.query=e,this.Yu=t,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=Wn(),this.mutatedKeys=Wn(),this.tc=Mn(e),this.ec=new Ba(this.tc)}get nc(){return this.Yu}sc(e,t){const n=t?t.ic:new Ga,r=t?t.ec:this.ec;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Fn(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.rc(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.tc(l,a)>0||c&&this.tc(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{ec:i,ic:n,zi:o,mutatedKeys:s}}rc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.ec;this.ec=e.ec,this.mutatedKeys=e.mutatedKeys;const s=e.ic.xu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return w()}};return n(e)-n(t)}(e.type,t.type)||this.tc(e.doc,t.doc))),this.oc(n);const i=t?this.uc():[],o=0===this.Zu.size&&this.current?1:0,a=o!==this.Xu;return this.Xu=o,0!==s.length||a?{snapshot:new za(this.query,e.ec,r,s,e.mutatedKeys,0===o,a,!1,!!n&&n.resumeToken.approximateByteSize()>0),cc:i}:{cc:i}}Mu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ec:this.ec,ic:new Ga,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(e){return!this.Yu.has(e)&&!!this.ec.has(e)&&!this.ec.get(e).hasLocalMutations}oc(e){e&&(e.addedDocuments.forEach((e=>this.Yu=this.Yu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Yu=this.Yu.delete(e))),this.current=e.current)}uc(){if(!this.current)return[];const e=this.Zu;this.Zu=Wn(),this.ec.forEach((e=>{this.ac(e.key)&&(this.Zu=this.Zu.add(e.key))}));const t=[];return e.forEach((e=>{this.Zu.has(e)||t.push(new rc(e))})),this.Zu.forEach((n=>{e.has(n)||t.push(new nc(n))})),t}hc(e){this.Yu=e.ir,this.Zu=Wn();const t=this.sc(e.documents);return this.applyChanges(t,!0)}lc(){return za.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class ic{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class oc{constructor(e){this.key=e,this.fc=!1}}class ac{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.dc={},this.wc=new On((e=>kn(e)),An),this._c=new Map,this.mc=new Set,this.gc=new Xe(K.comparator),this.yc=new Map,this.Ic=new io,this.Tc={},this.Ec=new Map,this.Ac=Mi.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function cc(e,t){const n=Vc(e);let r,s;const i=n.wc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.lc();else{const e=await Ao(n.localStore,Dn(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await uc(n,t,r,"current"===i,e.resumeToken),n.isPrimaryClient&&fa(n.remoteStore,e)}return s}async function uc(e,t,n,r,s){e.Rc=(t,n,r)=>async function(e,t,n,r){let s=t.view.sc(n);s.zi&&(s=await Ro(e.localStore,t.query,!1).then((({documents:e})=>t.view.sc(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Ic(e,t.targetId,o.cc),o.snapshot}(e,t,n,r);const i=await Ro(e.localStore,t,!0),o=new sc(t,i.ir),a=o.sc(i.documents),c=jr.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),u=o.applyChanges(a,e.isPrimaryClient,c);Ic(e,n,u.cc);const l=new ic(t,n,o);return e.wc.set(t,l),e._c.has(n)?e._c.get(n).push(t):e._c.set(n,[t]),u.snapshot}async function lc(e,t){const n=b(e),r=n.wc.get(t),s=n._c.get(r.targetId);if(s.length>1)return n._c.set(r.targetId,s.filter((e=>!An(e,t)))),void n.wc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await ko(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),ma(n.remoteStore,r.targetId),wc(n,r.targetId)})).catch(ne)):(wc(n,r.targetId),await ko(n.localStore,r.targetId,!0))}async function hc(e,t){const n=b(e);try{const e=await function(e,t){const n=b(e),r=t.snapshotVersion;let s=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Zi.newChangeBuffer({trackRemovals:!0});s=n.Ji;const o=[];t.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Bs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Bs.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(ot.EMPTY_BYTE_STRING,q.min()).withLastLimboFreeSnapshotVersion(q.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Bs.updateTargetData(e,u))}));let a=qn(),c=Wn();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(No(e,i,t.documentUpdates).next((e=>{a=e.nr,c=e.sr}))),!r.isEqual(q.min())){const t=n.Bs.getLastRemoteSnapshotVersion(e).next((t=>n.Bs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return re.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.Ji=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.yc.get(t);r&&(v(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.fc=!0:e.modifiedDocuments.size>0?v(r.fc):e.removedDocuments.size>0&&(v(r.fc),r.fc=!1))})),await Tc(n,e,t)}catch(e){await ne(e)}}function dc(e,t,n){const r=b(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.wc.forEach(((n,r)=>{const s=r.view.Mu(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=b(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const e of n.listeners)e.Mu(t)&&(r=!0)})),r&&Ya(n)}(r.eventManager,t),e.length&&r.dc.nu(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function fc(e,t,n){const r=b(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.yc.get(t),i=s&&s.key;if(i){let e=new Xe(K.comparator);e=e.insert(i,qt.newNoDocument(i,q.min()));const n=Wn().add(i),s=new $r(q.min(),new Map,new Xe(M),e,n);await hc(r,s),r.gc=r.gc.remove(i),r.yc.delete(t),Ec(r)}else await ko(r.localStore,t,!1).then((()=>wc(r,t,n))).catch(ne)}async function mc(e,t){const n=b(e),r=t.batch.batchId;try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Zi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=re.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);v(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=Wn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);yc(n,r,null),pc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Tc(n,e)}catch(e){await ne(e)}}async function gc(e,t,n){const r=b(e);try{const e=await function(e,t){const n=b(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(v(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);yc(r,t,n),pc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Tc(r,e)}catch(n){await ne(n)}}function pc(e,t){(e.Ec.get(t)||[]).forEach((e=>{e.resolve()})),e.Ec.delete(t)}function yc(e,t,n){const r=b(e);let s=r.Tc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Tc[r.currentUser.toKey()]=s}}function wc(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e._c.get(t))e.wc.delete(r),n&&e.dc.Pc(r,n);e._c.delete(t),e.isPrimaryClient&&e.Ic.Is(t).forEach((t=>{e.Ic.containsKey(t)||vc(e,t)}))}function vc(e,t){e.mc.delete(t.path.canonicalString());const n=e.gc.get(t);null!==n&&(ma(e.remoteStore,n),e.gc=e.gc.remove(t),e.yc.delete(n),Ec(e))}function Ic(e,t,n){for(const r of n)r instanceof nc?(e.Ic.addReference(r.key,t),bc(e,r)):r instanceof rc?(m("SyncEngine","Document no longer in limbo: "+r.key),e.Ic.removeReference(r.key,t),e.Ic.containsKey(r.key)||vc(e,r.key)):w()}function bc(e,t){const n=t.key,r=n.path.canonicalString();e.gc.get(n)||e.mc.has(r)||(m("SyncEngine","New document in limbo: "+n),e.mc.add(r),Ec(e))}function Ec(e){for(;e.mc.size>0&&e.gc.size<e.maxConcurrentLimboResolutions;){const t=e.mc.values().next().value;e.mc.delete(t);const n=new K(B.fromString(t)),r=e.Ac.next();e.yc.set(r,new oc(n)),e.gc=e.gc.insert(n,r),fa(e.remoteStore,new Fs(Dn(bn(n.path)),r,"TargetPurposeLimboResolution",ge.ct))}}async function Tc(e,t,n){const r=b(e),s=[],i=[],o=[];r.wc.isEmpty()||(r.wc.forEach(((e,a)=>{o.push(r.Rc(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){s.push(e);const t=Eo.Li(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.dc.nu(s),await async function(e,t){const n=b(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>re.forEach(t,(t=>re.forEach(t.Fi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>re.forEach(t.Bi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ce(e))throw e;m("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.Ji.get(t),r=e.snapshotVersion,s=e.withLastLimboFreeSnapshotVersion(r);n.Ji=n.Ji.insert(t,s)}}}(r.localStore,i))}async function Sc(e,t){const n=b(e);if(!n.currentUser.isEqual(t)){m("SyncEngine","User change. New user:",t.toKey());const e=await _o(n.localStore,t);n.currentUser=t,function(e,t){e.Ec.forEach((e=>{e.forEach((e=>{e.reject(new T(E.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Ec.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Tc(n,e.er)}}function xc(e,t){const n=b(e),r=n.yc.get(t);if(r&&r.fc)return Wn().add(r.key);{let e=Wn();const r=n._c.get(t);if(!r)return e;for(const t of r){const r=n.wc.get(t);e=e.unionWith(r.view.nc)}return e}}async function _c(e,t){const n=b(e),r=await Ro(n.localStore,t.query,!0),s=t.view.hc(r);return n.isPrimaryClient&&Ic(n,t.targetId,s.cc),s}async function Dc(e,t){const n=b(e);return Vo(n.localStore,t).then((e=>Tc(n,e)))}async function Nc(e,t,n,r){const s=b(e),i=await function(e,t){const n=b(e),r=b(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.Sn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):re.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await _a(s.remoteStore):"acknowledged"===n||"rejected"===n?(yc(s,t,r||null),pc(s,t),function(e,t){b(b(e).mutationQueue).Cn(t)}(s.localStore,t)):w(),await Tc(s,i)):m("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Cc(e,t,n){const r=b(e),s=[],i=[];for(const e of t){let t;const n=r._c.get(e);if(n&&0!==n.length){t=await Ao(r.localStore,Dn(n[0]));for(const e of n){const t=r.wc.get(e),n=await _c(r,t);n.snapshot&&i.push(n.snapshot)}}else{const n=await Fo(r.localStore,e);t=await Ao(r.localStore,n),await uc(r,Ac(n),e,!1,t.resumeToken)}s.push(t)}return r.dc.nu(i),s}function Ac(e){return In(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function kc(e){const t=b(e);return b(b(t.localStore).persistence).$i()}async function Rc(e,t,n,r){const s=b(e);if(s.vc)return void m("SyncEngine","Ignoring unexpected query state notification.");const i=s._c.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Vo(s.localStore,Vn(i[0])),r=$r.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ot.EMPTY_BYTE_STRING);await Tc(s,e,r);break}case"rejected":await ko(s.localStore,t,!0),wc(s,t,r);break;default:w()}}async function Fc(e,t,n){const r=Vc(e);if(r.vc){for(const e of t){if(r._c.has(e)){m("SyncEngine","Adding an already active target "+e);continue}const t=await Fo(r.localStore,e),n=await Ao(r.localStore,t);await uc(r,Ac(t),n.targetId,!1,n.resumeToken),fa(r.remoteStore,n)}for(const e of n)r._c.has(e)&&await ko(r.localStore,e,!1).then((()=>{ma(r.remoteStore,e),wc(r,e)})).catch(ne)}}function Vc(e){const t=b(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=hc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=xc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=fc.bind(null,t),t.dc.nu=Wa.bind(null,t.eventManager),t.dc.Pc=Ha.bind(null,t.eventManager),t}function Mc(e){const t=b(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=mc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=gc.bind(null,t),t}class Lc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=ra(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return xo(this.persistence,new To,e.initialUser,this.serializer)}createPersistence(e){return new ho(mo.zs,this.serializer)}createSharedClientState(e){return new jo}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Oc extends Lc{constructor(e,t,n){super(),this.Vc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Vc.initialize(this,e),await Mc(this.Vc.syncEngine),await _a(this.Vc.remoteStore),await this.persistence.Ii((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return xo(this.persistence,new To,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Gi(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new me(t,this.persistence);return new fe(e.asyncQueue,n)}createPersistence(e){const t=bo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Di.withCacheSize(this.cacheSizeBytes):Di.DEFAULT;return new wo(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ta(),na(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new jo}}class Pc extends Oc{constructor(e,t){super(e,t,!1),this.Vc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Vc.syncEngine;this.sharedClientState instanceof $o&&(this.sharedClientState.syncEngine={jr:Nc.bind(null,t),zr:Rc.bind(null,t),Wr:Fc.bind(null,t),$i:kc.bind(null,t),Qr:Dc.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ii((async e=>{await async function(e,t){const n=b(e);if(Vc(n),Mc(n),!0===t&&!0!==n.vc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Cc(n,e.toArray());n.vc=!0,await La(n.remoteStore,!0);for(const e of t)fa(n.remoteStore,e)}else if(!1===t&&!1!==n.vc){const e=[];let t=Promise.resolve();n._c.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(wc(n,s),ko(n.localStore,s,!0)))),ma(n.remoteStore,s)})),await t,await Cc(n,e),function(e){const t=b(e);t.yc.forEach(((e,n)=>{ma(t.remoteStore,n)})),t.Ic.Ts(),t.yc=new Map,t.gc=new Xe(K.comparator)}(n),n.vc=!1,await La(n.remoteStore,!1)}}(this.Vc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){const t=ta();if(!$o.D(t))throw new T(E.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=bo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new $o(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class qc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>dc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Sc.bind(null,this.syncEngine),await La(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new $a}createDatastore(e){const t=ra(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new ea(r));var r;return function(e,t,n,r){return new ca(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>dc(this.syncEngine,e,0),i=Wo.D()?new Wo:new Qo,new la(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new ac(e,t,n,r,s,i);return o&&(a.vc=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=b(e);m("RemoteStore","RemoteStore shutting down."),t.vu.add(5),await da(t),t.Pu.shutdown(),t.bu.set("Unknown")}(this.remoteStore)}}function Uc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Bc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Sc(this.observer.next,e)}error(e){this.observer.error?this.Sc(this.observer.error,e):g("Uncaught Error in snapshot listener:",e.toString())}Dc(){this.muted=!0}Sc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Gc{constructor(e,t){this.Cc=e,this.serializer=t,this.metadata=new S,this.buffer=new Uint8Array,this.xc=new TextDecoder("utf-8"),this.Nc().then((e=>{e&&e.Qu()?this.metadata.resolve(e.Gu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Gu)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Cc.cancel()}async getMetadata(){return this.metadata.promise}async bc(){return await this.getMetadata(),this.Nc()}async Nc(){const e=await this.kc();if(null===e)return null;const t=this.xc.decode(e),n=Number(t);isNaN(n)&&this.Mc(`length string (${t}) is not valid number`);const r=await this.$c(n);return new Ja(JSON.parse(r),e.length+n)}Oc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async kc(){for(;this.Oc()<0&&!await this.Fc(););if(0===this.buffer.length)return null;const e=this.Oc();e<0&&this.Mc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $c(e){for(;this.buffer.length<e;)await this.Fc()&&this.Mc("Reached the end of bundle when more is expected.");const t=this.xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Mc(e){throw this.Cc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Fc(){const e=await this.Cc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class zc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new T(E.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=b(e),r=gs(n.serializer)+"/documents",s={documents:t.map((e=>hs(n.serializer,e)))},i=await n.vo("BatchGetDocuments",r,s,t.length),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){v(!!t.found),t.found.name,t.found.updateTime;const n=ds(e,t.found.name),r=cs(t.found.updateTime),s=t.found.createTime?cs(t.found.createTime):q.min(),i=new Ot({mapValue:{fields:t.found.fields}});return qt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){v(!!t.missing),v(!!t.readTime);const n=ds(e,t.missing),r=cs(t.readTime);return qt.newNoDocument(n,r)}(e,t):w()}(n.serializer,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());v(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Dr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=K.fromPath(t);this.mutations.push(new Nr(n,this.precondition(n)))})),await async function(e,t){const n=b(e),r=gs(n.serializer)+"/documents",s={writes:t.map((e=>vs(n.serializer,e)))};await n.Io("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw w();t=q.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new T(E.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(q.min())?mr.exists(!1):mr.updateTime(t):mr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(q.min()))throw new T(E.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return mr.updateTime(t)}return mr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Kc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Bc=n.maxAttempts,this.qo=new sa(this.asyncQueue,"transaction_retry")}run(){this.Bc-=1,this.Lc()}Lc(){this.qo.No((async()=>{const e=new zc(this.datastore),t=this.qc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Uc(e)}))))})).catch((e=>{this.Uc(e)}))}))}qc(e){try{const t=this.updateFunction(e);return!pe(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Uc(e){this.Bc>0&&this.Kc(e)?(this.Bc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Lc(),Promise.resolve())))):this.deferred.reject(e)}Kc(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Mr(t)}return!1}}class $c{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=u.UNAUTHENTICATED,this.clientId=V.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{m("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(m("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new T(E.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new S;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Ua(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function jc(e,t){e.asyncQueue.verifyOperationInProgress(),m("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await _o(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Qc(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Hc(e);m("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>Ma(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Ma(t.remoteStore,n))),e._onlineComponents=t}function Wc(e){return"FirebaseError"===e.name?e.code===E.FAILED_PRECONDITION||e.code===E.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Hc(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){m("FirestoreClient","Using user provided OfflineComponentProvider");try{await jc(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!Wc(n))throw n;p("Error using user provided cache. Falling back to memory cache: "+n),await jc(e,new Lc)}}else m("FirestoreClient","Using default OfflineComponentProvider"),await jc(e,new Lc);return e._offlineComponents}async function Yc(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(m("FirestoreClient","Using user provided OnlineComponentProvider"),await Qc(e,e._uninitializedComponentsProvider._online)):(m("FirestoreClient","Using default OnlineComponentProvider"),await Qc(e,new qc))),e._onlineComponents}function Xc(e){return Hc(e).then((e=>e.persistence))}function Jc(e){return Hc(e).then((e=>e.localStore))}function Zc(e){return Yc(e).then((e=>e.remoteStore))}function eu(e){return Yc(e).then((e=>e.syncEngine))}async function tu(e){const t=await Yc(e),n=t.eventManager;return n.onListen=cc.bind(null,t.syncEngine),n.onUnlisten=lc.bind(null,t.syncEngine),n}function nu(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Bc({next:i=>{t.enqueueAndForget((()=>Qa(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new T(E.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new T(E.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new Xa(bn(n.path),i,{includeMetadataChanges:!0,Ku:!0});return ja(e,o)}(await tu(e),e.asyncQueue,t,n,r))),r.promise}function ru(e,t,n={}){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new Bc({next:n=>{t.enqueueAndForget((()=>Qa(e,o))),n.fromCache&&"server"===r.source?s.reject(new T(E.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new Xa(n,i,{includeMetadataChanges:!0,Ku:!0});return ja(e,o)}(await tu(e),e.asyncQueue,t,n,r))),r.promise}function su(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const iu=new Map;function ou(e,t,n){if(!n)throw new T(E.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function au(e,t,n,r){if(!0===t&&!0===r)throw new T(E.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function cu(e){if(!K.isDocumentKey(e))throw new T(E.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function uu(e){if(K.isDocumentKey(e))throw new T(E.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function lu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":w()}function hu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new T(E.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=lu(e);throw new T(E.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function du(e,t){if(t<=0)throw new T(E.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class fu{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new T(E.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new T(E.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}au("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=su(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new T(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new T(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new T(E.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class mu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new fu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new T(E.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new T(E.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new fu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new _;switch(e.type){case"firstParty":return new A(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new T(E.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=iu.get(e);t&&(m("ComponentProvider","Removing Datastore"),iu.delete(e),t.terminate())}(this),Promise.resolve()}}function gu(e,t,n,r={}){var s;const i=(e=hu(e,mu))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&p("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=u.MOCK_USER;else{t=(0,o.Fy)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new T(E.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new u(i)}e._authCredentials=new D(new x(t,n))}}class pu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new wu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new pu(this.firestore,e,this._key)}}class yu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new yu(this.firestore,e,this._query)}}class wu extends yu{constructor(e,t,n){super(e,t,bn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new pu(this.firestore,null,new K(e))}withConverter(e){return new wu(this.firestore,e,this._path)}}function vu(e,t,...n){if(e=(0,o.Ku)(e),ou("collection","path",t),e instanceof mu){const r=B.fromString(t,...n);return uu(r),new wu(e,null,r)}{if(!(e instanceof pu||e instanceof wu))throw new T(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(B.fromString(t,...n));return uu(r),new wu(e.firestore,null,r)}}function Iu(e,t){if(e=hu(e,mu),ou("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new T(E.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new yu(e,null,function(e){return new vn(B.emptyPath(),e)}(t))}function bu(e,t,...n){if(e=(0,o.Ku)(e),1===arguments.length&&(t=V.A()),ou("doc","path",t),e instanceof mu){const r=B.fromString(t,...n);return cu(r),new pu(e,null,new K(r))}{if(!(e instanceof pu||e instanceof wu))throw new T(E.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(B.fromString(t,...n));return cu(r),new pu(e.firestore,e instanceof wu?e.converter:null,new K(r))}}function Eu(e,t){return e=(0,o.Ku)(e),t=(0,o.Ku)(t),(e instanceof pu||e instanceof wu)&&(t instanceof pu||t instanceof wu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Tu(e,t){return e=(0,o.Ku)(e),t=(0,o.Ku)(t),e instanceof yu&&t instanceof yu&&e.firestore===t.firestore&&An(e._query,t._query)&&e.converter===t.converter}class Su{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new sa(this,"async_queue_retry"),this.Xc=()=>{const e=na();e&&m("AsyncQueue","Visibility state changed to "+e.visibilityState),this.qo.Mo()};const e=na();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Zc(),this.ta(e)}enterRestrictedMode(e){if(!this.jc){this.jc=!0,this.Jc=e||!1;const t=na();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xc)}}enqueue(e){if(this.Zc(),this.jc)return new Promise((()=>{}));const t=new S;return this.ta((()=>this.jc&&this.Jc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Qc.push(e),this.ea())))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(e){if(!ce(e))throw e;m("AsyncQueue","Operation failed with retryable error: "+e)}this.Qc.length>0&&this.qo.No((()=>this.ea()))}}ta(e){const t=this.Gc.then((()=>(this.Hc=!0,e().catch((e=>{this.Wc=e,this.Hc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw g("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Hc=!1,e))))));return this.Gc=t,t}enqueueAfterDelay(e,t,n){this.Zc(),this.Yc.indexOf(e)>-1&&(t=0);const r=qa.createAndSchedule(this,e,t,n,(e=>this.na(e)));return this.zc.push(r),r}Zc(){this.Wc&&w()}verifyOperationInProgress(){}async sa(){let e;do{e=this.Gc,await e}while(e!==this.Gc)}ia(e){for(const t of this.zc)if(t.timerId===e)return!0;return!1}ra(e){return this.sa().then((()=>{this.zc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.zc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.sa()}))}oa(e){this.Yc.push(e)}na(e){const t=this.zc.indexOf(e);this.zc.splice(t,1)}}function xu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return!0;return!1}(e)}class _u{constructor(){this._progressObserver={},this._taskCompletionResolver=new S,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Du=-1;class Nu extends mu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Su,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||ku(this),this._firestoreClient.terminate()}}function Cu(e,t){const n="object"==typeof e?e:(0,r.getApp)(),s="string"==typeof e?e:t||"(default)",i=(0,r._getProvider)(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=(0,o.yU)("firestore");e&&gu(i,...e)}return i}function Au(e){return e._firestoreClient||ku(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function ku(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new mt(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,su(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._firestoreClient=new $c(e._authCredentials,e._appCheckCredentials,e._queue,i),(null===(n=s.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.cache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.cache.kind,_offline:s.cache._offlineComponentProvider,_online:s.cache._onlineComponentProvider})}function Ru(e,t){Bu(e=hu(e,Nu));const n=Au(e);if(n._uninitializedComponentsProvider)throw new T(E.FAILED_PRECONDITION,"SDK cache is already specified.");p("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=e._freezeSettings(),s=new qc;return Vu(n,s,new Oc(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Fu(e){Bu(e=hu(e,Nu));const t=Au(e);if(t._uninitializedComponentsProvider)throw new T(E.FAILED_PRECONDITION,"SDK cache is already specified.");p("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),r=new qc;return Vu(t,r,new Pc(r,n.cacheSizeBytes))}function Vu(e,t,n){const r=new S;return e.asyncQueue.enqueue((async()=>{try{await jc(e,n),await Qc(e,t),r.resolve()}catch(e){const t=e;if(!Wc(t))throw t;p("Error enabling indexeddb cache. Falling back to memory cache: "+t),r.reject(t)}})).then((()=>r.promise))}function Mu(e){if(e._initialized&&!e._terminated)throw new T(E.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new S;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!ie.D())return Promise.resolve();const t=e+"main";await ie.delete(t)}(bo(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Lu(e){return function(e){const t=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=b(e);va(n.remoteStore)||m("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=b(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Ec.get(e)||[];r.push(t),n.Ec.set(e,r)}catch(e){const n=Ua(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await eu(e),t))),t.promise}(Au(e=hu(e,Nu)))}function Ou(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Xc(e),n=await Zc(e);return t.setNetworkEnabled(!0),function(e){const t=b(e);return t.vu.delete(0),ha(t)}(n)}))}(Au(e=hu(e,Nu)))}function Pu(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await Xc(e),n=await Zc(e);return t.setNetworkEnabled(!1),async function(e){const t=b(e);t.vu.add(0),await da(t),t.bu.set("Offline")}(n)}))}(Au(e=hu(e,Nu)))}function qu(e,t){const n=Au(e=hu(e,Nu)),r=new _u;return function(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?qr().encode(e):e,function(e,t){return new Gc(e,t)}(function(e,t){if(e instanceof Uint8Array)return Uc(e,t);if(e instanceof ArrayBuffer)return Uc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,ra(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=b(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=b(e),r=cs(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.qs.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(tc(r));const s=new ec(r,e.localStore,t.serializer);let i=await t.bc();for(;i;){const e=await s.zu(i);e&&n._updateProgress(e),i=await t.bc()}const o=await s.complete();return await Tc(e,o.Ju,void 0),await function(e,t){const n=b(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.qs.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Hu)}catch(e){return p("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await eu(e),s,r)}))}(n,e._databaseId,t,r),r}function Uu(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=b(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.qs.getNamedQuery(e,t)))}(await Jc(e),t)))}(Au(e=hu(e,Nu)),t).then((t=>t?new yu(e,null,t.query):null))}function Bu(e){if(e._initialized||e._terminated)throw new T(E.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Gu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Gu(ot.fromBase64String(e))}catch(e){throw new T(E.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Gu(ot.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class zu{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new T(E.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new z(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ku{constructor(e){this._methodName=e}}class $u{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new T(E.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new T(E.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return M(this._lat,e._lat)||M(this._long,e._long)}}const ju=/^__.*__$/;class Qu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Tr(e,this.data,this.fieldMask,t,this.fieldTransforms):new Er(e,this.data,t,this.fieldTransforms)}}class Wu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Tr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Hu(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw w()}}class Yu{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.ua(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(e){return new Yu(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.fa(e),r}da(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.aa({path:n,la:!1});return r.ua(),r}wa(e){return this.aa({path:void 0,la:!0})}_a(e){return pl(e,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}ua(){if(this.path)for(let e=0;e<this.path.length;e++)this.fa(this.path.get(e))}fa(e){if(0===e.length)throw this._a("Document fields must not be empty");if(Hu(this.ca)&&ju.test(e))throw this._a('Document fields cannot begin and end with "__"')}}class Xu{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ra(e)}ya(e,t,n,r=!1){return new Yu({ca:e,methodName:t,ga:n,path:z.emptyPath(),la:!1,ma:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function Ju(e){const t=e._freezeSettings(),n=ra(e._databaseId);return new Xu(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Zu(e,t,n,r,s,i={}){const o=e.ya(i.merge||i.mergeFields?2:0,t,n,s);dl("Data must be an object, but it was:",o,r);const a=ll(r,o);let c,u;if(i.merge)c=new rt(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=fl(t,r,n);if(!o.contains(s))throw new T(E.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);yl(e,s)||e.push(s)}c=new rt(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new Qu(new Ot(a),c,u)}class el extends Ku{_toFieldTransform(e){if(2!==e.ca)throw 1===e.ca?e._a(`${this._methodName}() can only appear at the top level of your update data`):e._a(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof el}}function tl(e,t,n){return new Yu({ca:3,ga:t.settings.ga,methodName:e._methodName,la:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class nl extends Ku{_toFieldTransform(e){return new dr(e.path,new sr)}isEqual(e){return e instanceof nl}}class rl extends Ku{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=tl(this,e,!0),n=this.pa.map((e=>ul(e,t))),r=new ir(n);return new dr(e.path,r)}isEqual(e){return this===e}}class sl extends Ku{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=tl(this,e,!0),n=this.pa.map((e=>ul(e,t))),r=new ar(n);return new dr(e.path,r)}isEqual(e){return this===e}}class il extends Ku{constructor(e,t){super(e),this.Ia=t}_toFieldTransform(e){const t=new ur(e.serializer,Zn(e.serializer,this.Ia));return new dr(e.path,t)}isEqual(e){return this===e}}function ol(e,t,n,r){const s=e.ya(1,t,n);dl("Data must be an object, but it was:",s,r);const i=[],a=Ot.empty();He(r,((e,r)=>{const c=gl(t,e,n);r=(0,o.Ku)(r);const u=s.da(c);if(r instanceof el)i.push(c);else{const e=ul(r,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new rt(i);return new Wu(a,c,s.fieldTransforms)}function al(e,t,n,r,s,i){const a=e.ya(1,t,n),c=[fl(t,r,n)],u=[s];if(i.length%2!=0)throw new T(E.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)c.push(fl(t,i[e])),u.push(i[e+1]);const l=[],h=Ot.empty();for(let e=c.length-1;e>=0;--e)if(!yl(l,c[e])){const t=c[e];let n=u[e];n=(0,o.Ku)(n);const r=a.da(t);if(n instanceof el)l.push(t);else{const e=ul(n,r);null!=e&&(l.push(t),h.set(t,e))}}const d=new rt(l);return new Wu(h,d,a.fieldTransforms)}function cl(e,t,n,r=!1){return ul(n,e.ya(r?4:3,t))}function ul(e,t){if(hl(e=(0,o.Ku)(e)))return dl("Unsupported field value:",t,e),ll(e,t);if(e instanceof Ku)return function(e,t){if(!Hu(t.ca))throw t._a(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t._a(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.la&&4!==t.ca)throw t._a("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=ul(s,t.wa(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Zn(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=P.fromDate(e);return{timestampValue:is(t.serializer,n)}}if(e instanceof P){const n=new P(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:is(t.serializer,n)}}if(e instanceof $u)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Gu)return{bytesValue:os(t.serializer,e._byteString)};if(e instanceof pu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t._a(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:us(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t._a(`Unsupported field value: ${lu(e)}`)}(e,t)}function ll(e,t){const n={};return Ye(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):He(e,((e,r)=>{const s=ul(r,t.ha(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function hl(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof P||e instanceof $u||e instanceof Gu||e instanceof pu||e instanceof Ku)}function dl(e,t,n){if(!hl(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=lu(n);throw"an object"===r?t._a(e+" a custom object"):t._a(e+" "+r)}}function fl(e,t,n){if((t=(0,o.Ku)(t))instanceof zu)return t._internalPath;if("string"==typeof t)return gl(e,t);throw pl("Field path arguments must be of type string or ",e,!1,void 0,n)}const ml=new RegExp("[~\\*/\\[\\]]");function gl(e,t,n){if(t.search(ml)>=0)throw pl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new zu(...t.split("."))._internalPath}catch(r){throw pl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function pl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new T(E.INVALID_ARGUMENT,a+e+c)}function yl(e,t){return e.some((e=>e.isEqual(t)))}class wl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new pu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new vl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Il("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class vl extends wl{data(){return super.data()}}function Il(e,t){return"string"==typeof t?gl(e,t):t instanceof zu?t._internalPath:t._delegate._internalPath}function bl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new T(E.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class El{}class Tl extends El{}function Sl(e,t,...n){let r=[];t instanceof El&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof Dl)).length,n=e.filter((e=>e instanceof xl)).length;if(t>1||t>0&&n>0)throw new T(E.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const t of r)e=t._apply(e);return e}class xl extends Tl{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new xl(e,t,n)}_apply(e){const t=this._parse(e);return Kl(e._query,t),new yu(e.firestore,e.converter,Nn(e._query,t))}_parse(e){const t=Ju(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new T(E.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){zl(o,i);const t=[];for(const n of o)t.push(Gl(r,e,n));a={arrayValue:{values:t}}}else a=Gl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||zl(o,i),a=cl(n,"where",o,"in"===i||"not-in"===i);return jt.create(s,i,a)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function _l(e,t,n){const r=t,s=Il("where",e);return xl._create(s,r,n)}class Dl extends El{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Dl(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:Qt.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const e of r)Kl(n,e),n=Nn(n,e)}(e._query,t),new yu(e.firestore,e.converter,Nn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function Nl(...e){return e.forEach((e=>jl("or",e))),Dl._create("or",e)}function Cl(...e){return e.forEach((e=>jl("and",e))),Dl._create("and",e)}class Al extends Tl{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Al(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new T(E.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new T(E.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new zt(t,n);return function(e,t){if(null===Tn(e)){const n=Sn(e);null!==n&&$l(0,n,t.field)}}(e,r),r}(e._query,this._field,this._direction);return new yu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new vn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function kl(e,t="asc"){const n=t,r=Il("orderBy",e);return Al._create(r,n)}class Rl extends Tl{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Rl(e,t,n)}_apply(e){return new yu(e.firestore,e.converter,Cn(e._query,this._limit,this._limitType))}}function Fl(e){return du("limit",e),Rl._create("limit",e,"F")}function Vl(e){return du("limitToLast",e),Rl._create("limitToLast",e,"L")}class Ml extends Tl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Ml(e,t,n)}_apply(e){const t=Bl(e,this.type,this._docOrFields,this._inclusive);return new yu(e.firestore,e.converter,function(e,t){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function Ll(...e){return Ml._create("startAt",e,!0)}function Ol(...e){return Ml._create("startAfter",e,!1)}class Pl extends Tl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Pl(e,t,n)}_apply(e){const t=Bl(e,this.type,this._docOrFields,this._inclusive);return new yu(e.firestore,e.converter,function(e,t){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function ql(...e){return Pl._create("endBefore",e,!1)}function Ul(...e){return Pl._create("endAt",e,!0)}function Bl(e,t,n,r){if(n[0]=(0,o.Ku)(n[0]),n[0]instanceof wl)return function(e,t,n,r,s){if(!r)throw new T(E.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of _n(e))if(n.field.isKeyField())i.push(xt(t,r.key));else{const e=r.data.field(n.field);if(ht(e))throw new T(E.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new T(E.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Ut(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=Ju(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new T(E.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const c=s[i];if(o[i].field.isKeyField()){if("string"!=typeof c)throw new T(E.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof c}`);if(!xn(e)&&-1!==c.indexOf("/"))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(B.fromString(c));if(!K.isDocumentKey(n))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new K(n);a.push(xt(t,s))}else{const e=cl(n,r,c);a.push(e)}}return new Ut(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function Gl(e,t,n){if("string"==typeof(n=(0,o.Ku)(n))){if(""===n)throw new T(E.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!xn(t)&&-1!==n.indexOf("/"))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(B.fromString(n));if(!K.isDocumentKey(r))throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return xt(e,new K(r))}if(n instanceof pu)return xt(e,n._key);throw new T(E.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${lu(n)}.`)}function zl(e,t){if(!Array.isArray(e)||0===e.length)throw new T(E.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Kl(e,t){if(t.isInequality()){const n=Sn(e),r=t.field;if(null!==n&&!n.isEqual(r))throw new T(E.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${r.toString()}'`);const s=Tn(e);null!==s&&$l(0,r,s)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new T(E.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new T(E.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function $l(e,t,n){if(!n.isEqual(t))throw new T(E.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}function jl(e,t){if(!(t instanceof xl||t instanceof Dl))throw new T(E.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Ql{convertValue(e,t="none"){switch(wt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ut(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(lt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw w()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return He(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new $u(ut(e.latitude),ut(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=dt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(ft(e));default:return null}}convertTimestamp(e){const t=ct(e);return new P(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=B.fromString(e);v(Rs(n));const r=new gt(n.get(1),n.get(3)),s=new K(n.popFirst(5));return r.isEqual(t)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Wl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Hl extends Ql{constructor(e){super(),this.firestore=e}convertBytes(e){return new Gu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new pu(this.firestore,null,t)}}class Yl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Xl extends wl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Jl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Il("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Jl extends Xl{data(e={}){return super.data(e)}}class Zl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Yl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Jl(this._firestore,this._userDataWriter,n.key,n,new Yl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new T(E.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Jl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Yl(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Jl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Yl(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:eh(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function eh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return w()}}function th(e,t){return e instanceof Xl&&t instanceof Xl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Zl&&t instanceof Zl&&e._firestore===t._firestore&&Tu(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function nh(e){e=hu(e,pu);const t=hu(e.firestore,Nu);return nu(Au(t),e._key).then((n=>ph(t,e,n)))}class rh extends Ql{constructor(e){super(),this.firestore=e}convertBytes(e){return new Gu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new pu(this.firestore,null,t)}}function sh(e){e=hu(e,pu);const t=hu(e.firestore,Nu),n=Au(t),r=new rh(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=b(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new T(E.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=Ua(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await Jc(e),t,n))),n.promise}(n,e._key).then((n=>new Xl(t,r,e._key,n,new Yl(null!==n&&n.hasLocalMutations,!0),e.converter)))}function ih(e){e=hu(e,pu);const t=hu(e.firestore,Nu);return nu(Au(t),e._key,{source:"server"}).then((n=>ph(t,e,n)))}function oh(e){e=hu(e,yu);const t=hu(e.firestore,Nu),n=Au(t),r=new rh(t);return bl(e._query),ru(n,e._query).then((n=>new Zl(t,r,e,n)))}function ah(e){e=hu(e,yu);const t=hu(e.firestore,Nu),n=Au(t),r=new rh(t);return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Ro(e,t,!0),s=new sc(t,r.ir),i=s.sc(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=Ua(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await Jc(e),t,n))),n.promise}(n,e._query).then((n=>new Zl(t,r,e,n)))}function ch(e){e=hu(e,yu);const t=hu(e.firestore,Nu),n=Au(t),r=new rh(t);return ru(n,e._query,{source:"server"}).then((n=>new Zl(t,r,e,n)))}function uh(e,t,n){e=hu(e,pu);const r=hu(e.firestore,Nu),s=Wl(e.converter,t,n);return gh(r,[Zu(Ju(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,mr.none())])}function lh(e,t,n,...r){e=hu(e,pu);const s=hu(e.firestore,Nu),i=Ju(s);let a;return a="string"==typeof(t=(0,o.Ku)(t))||t instanceof zu?al(i,"updateDoc",e._key,t,n,r):ol(i,"updateDoc",e._key,t),gh(s,[a.toMutation(e._key,mr.exists(!0))])}function hh(e){return gh(hu(e.firestore,Nu),[new Dr(e._key,mr.none())])}function dh(e,t){const n=hu(e.firestore,Nu),r=bu(e),s=Wl(e.converter,t);return gh(n,[Zu(Ju(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,mr.exists(!1))]).then((()=>r))}function fh(e,...t){var n,r,s;e=(0,o.Ku)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||xu(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(xu(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,l,h;if(e instanceof pu)l=hu(e.firestore,Nu),h=bn(e._key.path),u={next:n=>{t[a]&&t[a](ph(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=hu(e,yu);l=hu(n.firestore,Nu),h=n._query;const r=new rh(l);u={next:e=>{t[a]&&t[a](new Zl(l,r,n,e))},error:t[a+1],complete:t[a+2]},bl(e._query)}return function(e,t,n,r){const s=new Bc(r),i=new Xa(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>ja(await tu(e),i))),()=>{s.Dc(),e.asyncQueue.enqueueAndForget((async()=>Qa(await tu(e),i)))}}(Au(l),h,c,u)}function mh(e,t){return function(e,t){const n=new Bc(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).ku.add(t),t.next()}(await tu(e),n))),()=>{n.Dc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){b(e).ku.delete(t)}(await tu(e),n)))}}(Au(e=hu(e,Nu)),xu(t)?t:{next:t})}function gh(e,t){return function(e,t){const n=new S;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Mc(e);try{const e=await function(e,t){const n=b(e),r=P.now(),s=t.reduce(((e,t)=>e.add(t.key)),Wn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=qn(),c=Wn();return n.Zi.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=Ir(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new Tr(e.key,t,Pt(t.value.mapValue),mr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Gn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Tc[e.currentUser.toKey()];r||(r=new Xe(M)),r=r.insert(t,n),e.Tc[e.currentUser.toKey()]=r}(r,e.batchId,n),await Tc(r,e.changes),await _a(r.remoteStore)}catch(e){const t=Ua(e,"Failed to persist write");n.reject(t)}}(await eu(e),t,n))),n.promise}(Au(e),t)}function ph(e,t,n){const r=n.docs.get(t._key),s=new rh(e);return new Xl(e,s,t._key,r,new Yl(n.hasPendingWrites,n.fromCache),t.converter)}const yh={maxAttempts:5};class wh{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Ju(e)}set(e,t,n){this._verifyNotCommitted();const r=vh(e,this._firestore),s=Wl(r.converter,t,n),i=Zu(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,mr.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=vh(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof zu?al(this._dataReader,"WriteBatch.update",s._key,t,n,r):ol(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,mr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=vh(e,this._firestore);return this._mutations=this._mutations.concat(new Dr(t._key,mr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new T(E.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function vh(e,t){if((e=(0,o.Ku)(e)).firestore!==t)throw new T(E.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Ih extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Ju(e)}get(e){const t=vh(e,this._firestore),n=new Hl(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return w();const r=e[0];if(r.isFoundDocument())return new wl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new wl(this._firestore,n,t._key,null,t.converter);throw w()}))}set(e,t,n){const r=vh(e,this._firestore),s=Wl(r.converter,t,n),i=Zu(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=vh(e,this._firestore);let i;return i="string"==typeof(t=(0,o.Ku)(t))||t instanceof zu?al(this._dataReader,"Transaction.update",s._key,t,n,r):ol(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=vh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=vh(e,this._firestore),n=new rh(this._firestore);return super.get(e).then((e=>new Xl(this._firestore,n,t._key,e._document,new Yl(!1,!1),t.converter)))}}function bh(e,t,n){e=hu(e,Nu);const r=Object.assign(Object.assign({},yh),n);return function(e){if(e.maxAttempts<1)throw new T(E.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new S;return e.asyncQueue.enqueueAndForget((async()=>{const s=await function(e){return Yc(e).then((e=>e.datastore))}(e);new Kc(e.asyncQueue,s,n,t,r).run()})),r.promise}(Au(e),(n=>t(new Ih(e,n))),r)}function Eh(){return new el("deleteField")}function Th(){return new nl("serverTimestamp")}function Sh(...e){return new rl("arrayUnion",e)}function xh(...e){return new sl("arrayRemove",e)}function _h(e){return new il("increment",e)}function Dh(e){return Au(e=hu(e,Nu)),new wh(e,(t=>gh(e,t)))}!function(e,t=!0){!function(e){l=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.uA("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new Nu(new N(e.getProvider("auth-internal")),new R(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new T(E.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new gt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),(0,r.registerVersion)(c,"3.13.0",e),(0,r.registerVersion)(c,"3.13.0","esm2017")}()}}]);